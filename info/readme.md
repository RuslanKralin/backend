# –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞

### 1. –û–±—â–∏–π npm –ø–∞–∫–µ—Ç (ticket-for-cinema-service)

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –≤—Å–µ –Ω–∞—à–∏ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã, —Ç–∏–ø—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:** –°–æ–∑–¥–∞–ª–∏ –ø–∞–∫–µ—Ç —Å prettier, —É—Ç–∏–ª–∏—Ç–∞–º–∏ –∏ –æ–±—â–∏–º–∏ —Ç–∏–ø–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –≤ –ª—é–±–æ–π —Å–µ—Ä–≤–∏—Å.

### 2. Gateway-service - –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π –≤—Ö–æ–¥

**–ó–∞—á–µ–º:** –≠—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ –±–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
- –í–∫–ª—é—á–∏–ª–∏ CORS (—á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–≥ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API)
- –î–æ–±–∞–≤–∏–ª–∏ HealthCheck (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç)
- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ Swagger (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –≤ –±—Ä–∞—É–∑–µ—Ä–µ)

### 3. gRPC –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å—ã –º–æ–≥–ª–∏ –æ–±—â–∞—Ç—å—Å—è –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º –ø–æ –±—ã—Å—Ç—Ä–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É gRPC.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –°–æ–∑–¥–∞–ª–∏ —Ñ–∞–π–ª `auth.proto` - —ç—Ç–æ –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏
- –û–ø–∏—Å–∞–ª–∏ —Ç–∞–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã (–æ—Ç–ø—Ä–∞–≤–∫–∞ OTP, –ø—Ä–æ–≤–µ—Ä–∫–∞ OTP)
- –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ TypeScript —Ç–∏–ø—ã –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
- –û–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ –≤ npm –ø–∞–∫–µ—Ç —á—Ç–æ–±—ã –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Ç–∏–ø—ã

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ gRPC –æ–±—â–µ–Ω–∏—è

**–ó–∞—á–µ–º:** Auth Service –∏ Gateway –¥–æ–ª–∂–Ω—ã –ø–æ–Ω–∏–º–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ gRPC –∫–ª–∏–µ–Ω—Ç –≤ Gateway (–æ–Ω –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ Auth)
- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ gRPC —Å–µ—Ä–≤–µ—Ä –≤ Auth Service (–æ–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Gateway)
- –¢–µ–ø–µ—Ä—å –æ–Ω–∏ –º–æ–≥—É—Ç –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏ –ø–æ gRPC –ø—Ä–æ—Ç–æ–∫–æ–ª—É

### 5. Docker-compose –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –ª–µ–≥–∫–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤–º–µ—Å—Ç–µ.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:** –°–æ–∑–¥–∞–ª–∏ –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç Gateway, Auth Service, PostgreSQL –∏ Redis –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.

### 6. Prisma ORM –≤ Auth Service

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã —É–¥–æ–±–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö PostgreSQL.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ Prisma –∏ –∫–ª–∏–µ–Ω—Ç –¥–ª—è PostgreSQL
- –°–æ–∑–¥–∞–ª–∏ `schema.prisma` - —Ñ–∞–π–ª –≥–¥–µ –æ–ø–∏—Å–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—à–µ–π –±–∞–∑—ã
- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ —á–µ—Ä–µ–∑ `.env` —Ñ–∞–π–ª
- –¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π —á–µ—Ä–µ–∑ —É–¥–æ–±–Ω—ã–µ TypeScript —Ñ—É–Ω–∫—Ü–∏–∏

### 7. Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è OTP –∫–æ–¥–æ–≤

**–ó–∞—á–µ–º:** OTP –∫–æ–¥—ã –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –ü–æ–¥–∫–ª—é—á–∏–ª–∏ Redis –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º localhost –∏ –ø–æ—Ä—Ç–æ–º 6379
- –¢–µ–ø–µ—Ä—å OTP –∫–æ–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis —Å –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ (TTL)

### 8. –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ OTP

**–ó–∞—á–µ–º:** –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ OTP –∫–æ–¥–æ–≤.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –°–æ–∑–¥–∞–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ OTP (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, —Ö–µ—à–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis)
- –°–æ–∑–¥–∞–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ OTP (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º)
- –ï—Å–ª–∏ –∫–æ–¥ –≤–µ—Ä–Ω—ã–π - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º access –∏ refresh —Ç–æ–∫–µ–Ω—ã

### 9. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ó–∞—á–µ–º:** –û—à–∏–±–∫–∏ –∏–∑ Auth Service –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ gRPC —Ñ–æ—Ä–º–∞—Ç–µ, –∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω—ã –ø–æ–Ω—è—Ç–Ω—ã–µ HTTP –æ—à–∏–±–∫–∏.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –°–æ–∑–¥–∞–ª–∏ `GlobalExceptionFilter` - —ç—Ç–æ –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –æ—à–∏–±–æ–∫
- –û–Ω –ª–æ–≤–∏—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ –æ—à–∏–±–∫–∏ –≤ Gateway
- gRPC –æ—à–∏–±–∫—É "5 NOT_FOUND: Invalid code" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤ HTTP 404 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "Invalid code"
- –í—Å–µ –æ—à–∏–±–∫–∏ —Ç–µ–ø–µ—Ä—å –≤ –æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞—é—Ç—Å—è –≤ Swagger

### 10. –û–±—â–∏–µ —Ç–∏–ø—ã –∏ enum'—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –Ω–∞ –æ–¥–Ω–æ–º —è–∑—ã–∫–µ.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –°–æ–∑–¥–∞–ª–∏ –ø–∞–ø–∫—É `common/lib/enums` –¥–ª—è –æ–±—â–∏—Ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π (—Å—Ç–∞—Ç—É—Å—ã, —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ —Ç.–¥.)
- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ —Ç–∞–º package.json –∏ TypeScript
- –≠—Ç–æ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ npm –ø–∞–∫–µ—Ç —á—Ç–æ–±—ã –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Ç–∏–ø—ã

### 11. –ö–∞—Å—Ç–æ–º–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (.env —Ñ–∞–π–ª—ã) –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
**–ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ–º:** –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç `common/lib/env` –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.

---

    —ç—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∫–æ–º–∏—Ç–∞
    git commit --allow-empty -m "trigger: test with new commit"

### 12. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤ (Passport Token)

**–ó–∞—á–µ–º:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –∏ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç JWT –±–∏–±–ª–∏–æ—Ç–µ–∫.
**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**

- –°–æ–∑–¥–∞–ª–∏ –ø–∞–∫–µ—Ç `passport` —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –¢–æ–∫–µ–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —á–∞—Å—Ç–µ–π: `userId.iat.exp.signature`
- **userId** - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ base64Url
- **iat** - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –≤ timestamp (base64Url)
- **exp** - –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤ timestamp (base64Url)
- **signature** - HMAC –ø–æ–¥–ø–∏—Å—å –æ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
const token = generateToken(secretKey, userId, ttlInSeconds);
// –†–µ–∑—É–ª—å—Ç–∞—Ç: dXNlcklkLWFzZGFzYXNk.MTc2Nzc5NDM0Ng.MTc2Nzc5Nzk0Ng.6y8wzZbBlK2I6L0mSkXyjyr/XnGniFnczW9zcjh7Eas=

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
const result = verifyToken(secretKey, token);
// –†–µ–∑—É–ª—å—Ç–∞—Ç: { valid: true, userId: 'userId-asdasasd' }
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- HMAC –ø–æ–¥–ø–∏—Å—å —Å —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º - –Ω–µ–ª—å–∑—è –ø–æ–¥–¥–µ–ª–∞—Ç—å
- `constantTimeEqual` - –∑–∞—â–∏—Ç–∞ –æ—Ç timing attacks
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è - —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å—Ç–µ–∫–∞—é—Ç
- Base64Url –∫–æ–¥–∏—Ä–æ–≤–∫–∞ - –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è URL

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:**

```
passport/lib/
‚îú‚îÄ‚îÄ index.ts          # –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ generateToken/verifyToken
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ base64.ts     # base64UrlEncode/Decode –¥–ª—è URL-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ crypto.ts     # constantTimeEqual –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∞—Ç–∞–∫
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ JWT:**

- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ñ–æ—Ä–º–∞—Ç–æ–º –∏ –ª–æ–≥–∏–∫–æ–π
- ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Ç–æ–ª—å–∫–æ Node.js crypto)
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ª–∞–¥–∫–∞ - –≤—Å–µ —á–∞—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ —á–∏—Ç–∞–µ–º—ã
- ‚úÖ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ JWT –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### 13. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–æ–¥—É–ª—å

yarn add @nestjs/common @nestjs/core reflect-metadata txjs
–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —è –µ–≥–æ –ø–æ–¥–∫–ª—é—á–∏–ª –≤ auth-service –∏ —Ç–µ–ø–µ—Ä—å —Ç–∞–º –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è access –∏ refresh —Ç–æ–∫–µ–Ω—ã –º–µ—Ç–æ–¥–∞–º–∏ –∏–∑ –º–æ–µ–≥–æ –ø–∞–∫–µ—Ç–∞ passport –∫–æ—Ç–æ—Ä—ã–π —è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –≤ npm

### 14. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞ –≤ –∫—É–∫–∏ –Ω–∞ gateway service

```bash
yarn add cookie-parser
yarn add -D @types/cookie-parser
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞—â–∏—Ç—ã –∫—É–∫–∏:**

1. `httpOnly: true` - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫ (—Å–∫—Ä–∏–ø—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫—É–∫–∏)
2. `secure: true` (–≤ production) - –ø–µ—Ä–µ–¥–∞—á–∞ –∫—É–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ HTTPS
3. `sameSite: 'lax'` - –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫
4. `domain: configService.get('COOKIES_DOMAIN')` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞
5. `maxAge: 30 –¥–Ω–µ–π` - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ refresh —Ç–æ–∫–µ–Ω–∞
6. `signed: true` —Å COOKIES_SECRET - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–º–µ–Ω—ã –∫—É–∫–∏

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**

```typescript
res.cookie("refreshToken", refreshToken, {
  httpOnly: true, // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
  secure: process.env.NODE_ENV === "production", // –¢–æ–ª—å–∫–æ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
  sameSite: "lax", // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
  domain: configService.get("COOKIES_DOMAIN"),
  maxAge: 30 * 24 * 60 * 60 * 1000, // 30 –¥–Ω–µ–π
  signed: true, // –ü–æ–¥–ø–∏—Å—å –∫—É–∫–∏
});
```

**–ö—Ä–∞—Ç–∫–æ –æ–± –∞—Ç–∞–∫–∞—Ö:**

- **XSS (Cross-Site Scripting)**: –í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.
  _–ó–∞—â–∏—Ç–∞:_ `httpOnly` –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø JavaScript –∫ –∫—É–∫–∏.
- **CSRF (Cross-Site Request Forgery)**: –ü–æ–¥–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¥—Ä—É–≥–∏—Ö —Å–∞–π—Ç–æ–≤.
  _–ó–∞—â–∏—Ç–∞:_ `sameSite: 'lax'` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∫—É–∫.

- **–ü–æ–¥–º–µ–Ω–∞ –∫—É–∫**: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∫—É–∫.
  _–ó–∞—â–∏—Ç–∞:_ `signed: true` —Å COOKIES_SECRET.

- **–ü–µ—Ä–µ—Ö–≤–∞—Ç –∫—É–∫**: –í –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–µ—Ç–∏.
  _–ó–∞—â–∏—Ç–∞:_ `secure: true` (HTTPS).

- **–£—Ç–µ—á–∫–∞ –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω–∞—Ö**:
  _–ó–∞—â–∏—Ç–∞:_ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ `domain`.

### 15. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

1. –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –≤ contracts (auth.proto –¥–æ–±–∞–∏—Ç—å –º–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
   –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞, –º—ã –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É access/refresh —Ç–æ–∫–µ–Ω–æ–≤ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—É–∫–∏ —Å –Ω–æ–≤—ã–º refresh —Ç–æ–∫–µ–Ω–æ–º.

### 16. logout

–æ—á–∏—Å—Ç–∫–∞ –∫—É–∫–∏

### 17. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è guards –∏ decorators –¥–ª—è –∑–∞—â–∏—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≥–¥–µ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

—Ç—É—Ç –º—ã —Å–æ–±–ª—é–¥–∞–µ–º SRP –∏ –Ω–µ –ø–∏—Ö–∞–µ–º –∏—Ö –≤ –Ω–∞—à—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É passport (–æ–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç userId, –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç, –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –æ–Ω –Ω–µ –ø–æ–¥–¥–µ–ª–∞–Ω ), –Ω–∞—à–∏ –≤—Å–µ —ç—Ç–∏ —à—Ç—É–∫–∏ —Ä–∞—Å–ø–æ–ª–æ–≥–∞—é—Ç—Å—è —á–∏—Å—Ç–æ –≤ gateway. Guard –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç userId, decorator –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ userId –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –∂–µ guard)

### 18. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –∫ user –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ + role.

–†–æ–ª—å –Ω—É–∂–Ω–∞ –±—É–¥–µ—Ç —á—Ç–æ–± –∞–¥–º–∏–Ω –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ–∞–Ω—Å—ã, –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–∏–ª—å–º—ã –∏ —Ç.–ø. –ö–æ—Ä–æ—á–µ –∞–¥–º–∏–Ω—Å–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 19. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –≤ contracts (auth.proto –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤)
2. –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –ø–æ—á—Ç–∞ –∏ —Ç–ø –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ —Å–µ—Ä–≤–∏—Å–µ account –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Å–º–µ–Ω–∞ –∏ —Ç–∞–º —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏ —á—Ç–æ–± –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω—Ç—å –∫–æ–¥ —è –≤—ã–Ω–æ—à—É —ç—Ç—É –ª–æ–≥–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å (User —Å–µ—Ä–≤–∏—Å, –Ω–æ —ç—Ç–æ –Ω–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å!)

### 20. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram

> üìö **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `info/telegram-auth-complete-guide.md`

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ **4 —Å–µ—Ä–≤–∏—Å–æ–≤**:

1. **Frontend** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram")
2. **Gateway Service** - HTTP API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
3. **Auth Service** - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞ —Å –ë–î –∏ Redis
4. **Bot Service** - Telegram –±–æ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

#### –î–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–µ—Å—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)**

```
Frontend ‚Üí Gateway ‚Üí Auth Service ‚Üí Telegram OAuth ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ‚Üí
–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚úÖ
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)**

```
Frontend ‚Üí Gateway ‚Üí Auth Service ‚Üí Telegram OAuth ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ‚Üí
–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ Redis ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ ‚Üí –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ ‚Üí
–°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚úÖ
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

##### 1. gRPC –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã (`contracts/proto/auth.proto`)

–î–æ–±–∞–≤–ª–µ–Ω—ã **4 –º–µ—Ç–æ–¥–∞** –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

- `TelegramInit()` - –ø–æ–ª—É—á–µ–Ω–∏–µ OAuth URL
- `TelegramVerify(query)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- `TelegramComplete(sessionId, phone)` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- `TelegramConsume(sessionId)` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

##### 2. Auth Service

**TokenService** (`auth-service/src/modules/token/`)

- **–ü—Ä–∏—á–∏–Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è**: –∏–∑–±–µ–∂–∞–Ω–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **–ú–µ—Ç–æ–¥—ã**:
  - `generateTokens(userId)` - —Å–æ–∑–¥–∞–µ—Ç access –∏ refresh —Ç–æ–∫–µ–Ω—ã
  - `verify(token)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞

**TelegramService** (`auth-service/src/modules/telegram/`)

- `getAuthUrl()` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç OAuth URL
- `verify(data)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- `complete(sessionId, phone)` - —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã
- `consumeSession(sessionId)` - –æ—Ç–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
- `checkTelegramAuth(query)` - –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏

**TelegramRepository** - —Ä–∞–±–æ—Ç–∞ —Å –ë–î –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ `telegramId`

**UserRepo** - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–°—Ö–µ–º–∞ –ë–î** (`prisma/schema.prisma`)

```prisma
model Account {
  telegramId String? @unique  // –î–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
  phone String?               // –ü–æ–ª—É—á–∞–µ–º –æ—Ç –±–æ—Ç–∞
  isPhoneVerified Boolean     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ true –ø–æ—Å–ª–µ –±–æ—Ç–∞
}
```

##### 3. Gateway Service

**HTTP Endpoints** (`gateway-service/src/modules/auth/`)

- `GET /auth/telegram` - –ø–æ–ª—É—á–µ–Ω–∏–µ OAuth URL
- `POST /auth/telegram/verify` - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram
- `POST /auth/telegram/finalize` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –±–æ—Ç–µ

**DTO –∫–ª–∞—Å—Å—ã**:

- `TelegramVerifyRequest` - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç base64-–∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- `TelegramFinalizeRequest` - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç sessionId

##### 4. Bot Service

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞** (`bot-service/src/`)

- `bot.factory.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ —Å session middleware
- `handlers/start.handler.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã `/start SESSION_ID`
- `handlers/contact.handler.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- `infra/grpc/auth.client.ts` - gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Å–≤—è–∑–∏ —Å Auth Service

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:

```json
{
  "telegraf": "^4.16.3", // Telegram Bot Framework
  "@grpc/grpc-js": "^1.12.4", // gRPC –∫–ª–∏–µ–Ω—Ç
  "@grpc/proto-loader": "^0.7.15", // –ó–∞–≥—Ä—É–∑–∫–∞ proto —Ñ–∞–π–ª–æ–≤
  "@nestjs/common": "^11.0.0", // –î–ª—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤
  "reflect-metadata": "^0.2.2" // –î–ª—è NestJS
}
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏**:

```typescript
// /start SESSION_ID - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç sessionId –≤ —Å–µ—Å—Å–∏—é –±–æ—Ç–∞
bot.start(async (ctx) => {
  const sessionId = ctx.startPayload;
  ctx.session.id = sessionId;
  await ctx.reply("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", {
    keyboard: [[Markup.button.contactRequest("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä")]],
  });
});

// contact - –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–º–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Auth Service
bot.on("contact", async (ctx) => {
  const phone = ctx.message.contact.phone_number;
  const sessionId = ctx.session.id;

  await authClient.telegramComplete({ sessionId, phone });

  await ctx.reply("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", {
    inline_keyboard: [
      [
        {
          text: "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç",
          url: `https://site.com/auth/tg-finalize?session_id=${sessionId}`,
        },
      ],
    ],
  });
});
```

#### –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Redis

**–ö–ª—é—á 1: `telegram_session:SESSION_ID`**

```json
{
  "telegramId": "525366794",
  "username": "Ruslan_Kralin"
}
```

- **TTL**: 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: —Å–≤—è–∑–∞—Ç—å telegramId —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ –±–æ—Ç–∞

**–ö–ª—é—á 2: `telegram_tokens:SESSION_ID`**

```json
{
  "accessToken": "eyJhbGc...",
  "refreshToken": "eyJhbGc..."
}
```

- **TTL**: 2 –º–∏–Ω—É—Ç—ã (120 —Å–µ–∫—É–Ω–¥)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ø–µ—Ä–µ–¥–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —á–µ—Ä–µ–∑ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å

#### –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

1. **Frontend**: `GET /auth/telegram` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç OAuth URL
2. **Frontend**: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Telegram OAuth –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
3. **Telegram**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ + hash
4. **Frontend**: `POST /auth/telegram/verify` —Å –¥–∞–Ω–Ω—ã–º–∏
5. **Auth Service**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å ‚úÖ
6. **Auth Service**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —Å–æ–∑–¥–∞–µ—Ç `sessionId`
7. **Auth Service ‚Üí Redis**: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `telegram_session:sessionId`
8. **Auth Service ‚Üí Gateway**: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –±–æ—Ç–∞ —Å `sessionId`
9. **Frontend**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram"
10. **User**: –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ `t.me/bot?start=SESSION_ID`
11. **Bot**: –ø–æ–ª—É—á–∞–µ—Ç `/start SESSION_ID` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Å–µ—Å—Å–∏—é
12. **Bot**: –ø—Ä–æ—Å–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
13. **User**: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–º–µ—Ä
14. **Bot ‚Üí Auth Service**: `TelegramComplete(sessionId, phone)`
15. **Auth Service ‚Üí Redis**: –¥–æ—Å—Ç–∞–µ—Ç `telegram_session:sessionId`
16. **Auth Service ‚Üí –ë–î**: —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
17. **Auth Service**: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã
18. **Auth Service ‚Üí Redis**: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `telegram_tokens:sessionId`
19. **Auth Service ‚Üí Redis**: —É–¥–∞–ª—è–µ—Ç `telegram_session:sessionId`
20. **Bot ‚Üí User**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç"
21. **User**: –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ `site.com/auth/tg-finalize?session_id=SESSION_ID`
22. **Frontend**: `POST /auth/telegram/finalize` —Å `sessionId`
23. **Auth Service ‚Üí Redis**: –¥–æ—Å—Ç–∞–µ—Ç `telegram_tokens:sessionId`
24. **Auth Service ‚Üí Redis**: —É–¥–∞–ª—è–µ—Ç `telegram_tokens:sessionId`
25. **Auth Service ‚Üí Gateway**: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã
26. **Gateway ‚Üí Frontend**: `accessToken` + Cookie `refreshToken`
27. **Frontend**: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**HMAC-SHA256 –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏**:

```typescript
// 1. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ hash)
const dataCheckStr = "first_name=Ruslan\nid=525366794\nusername=Ruslan_Kralin";

// 2. –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
const secretKey = sha256(`${BOT_ID}:${BOT_TOKEN}`);

// 3. –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å—å
const hmac = HMAC_SHA256(secretKey, dataCheckStr);

// 4. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å hash –æ—Ç Telegram
if (hmac === hash) {
  // ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–ª–∏–Ω–Ω—ã–µ
}
```

**–ó–∞—â–∏—Ç–∞**:

- ‚ùå –ù–µ–ª—å–∑—è –ø–æ–¥–¥–µ–ª–∞—Ç—å –¥–∞–Ω–Ω—ã–µ - –∏–∑–º–µ–Ω–∏—Ç—Å—è hash
- ‚ùå –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π hash - –Ω—É–∂–µ–Ω bot_token
- ‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è auth_date
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤ Redis —Å TTL
- ‚úÖ –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**:
   - `TokenService` - —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã (–∏–∑–±–µ–≥–∞–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
   - `TelegramService` - Telegram OAuth –ª–æ–≥–∏–∫–∞
   - `AuthService` - –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - `Bot Service` - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è Telegram –±–æ—Ç–∞

2. **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:
   - `TokenModule` —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TokenService`
   - `TelegramModule` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TokenService` –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `TelegramService`
   - `AuthModule` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –æ–±–∞ –º–æ–¥—É–ª—è

3. **gRPC –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è**:
   - Bot Service ‚Üí Auth Service —á–µ—Ä–µ–∑ gRPC
   - Gateway ‚Üí Auth Service —á–µ—Ä–µ–∑ gRPC
   - –ë—ã—Å—Ç—Ä–µ–µ HTTP/REST, —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

4. **Redis –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**:
   - `telegram_session:sessionId` - —Å–≤—è–∑—å OAuth —Å –±–æ—Ç–æ–º (TTL 5 –º–∏–Ω)
   - `telegram_tokens:sessionId` - –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ñ—Ä–æ–Ω—Ç (TTL 2 –º–∏–Ω)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ TTL

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**Auth Service** (`.env`):

```env
TELEGRAM_BOT_ID=7890123456
TELEGRAM_BOT_TOKEN=7890123456:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw
TELEGRAM_BOT_USERNAME=your_bot_username
TELEGRAM_REDIRECT_ORIGIN=https://ticket-for-cinema.com
```

**Bot Service** (`.env`):

```env
BOT_TOKEN=7890123456:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw
AUTH_GRPC_URL=localhost:50051
```

**Gateway Service** (`.env`):

```env
AUTH_GRPC_URL=localhost:50051
```

#### –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è **3 –º–µ—Ç–æ–¥–∞**:

- **Email + OTP** - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- **Phone + OTP** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- **Telegram OAuth + Bot** - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º –Ω–æ–º–µ—Ä–∞

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:

- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –∫ –æ–¥–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
- ‚úÖ –í—Ö–æ–¥ –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞

#### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: ~5 —Å–µ–∫—É–Ω–¥ (—Ç–æ–ª—å–∫–æ OAuth)
- **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: ~30 —Å–µ–∫—É–Ω–¥ (OAuth + –±–æ—Ç + —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)

#### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **"Invalid Telegram session"** - sessionId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Redis (–∏—Å—Ç–µ–∫ TTL –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á)
2. **–ë–æ—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç sessionId** - –Ω–µ –ø–µ—Ä–µ—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ —Å `?start=SESSION_ID`
3. **–°–µ—Å—Å–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** - –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è –º–µ–∂–¥—É `/start` –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–Ω—Ç–∞–∫—Ç–∞
4. **"Incorrect arguments passed"** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ gRPC –º–µ—Ç–æ–¥–∞ (–Ω—É–∂–µ–Ω callback)

### 21. –î–æ–±–∞–≤–ª—è–µ–º –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
