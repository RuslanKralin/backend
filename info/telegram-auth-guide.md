# ๐ ะะฒัะพัะธะทะฐัะธั ัะตัะตะท Telegram - ะฟะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ

## ๐ ะะฑะทะพั ะฟัะพัะตััะฐ

ะะฒัะพัะธะทะฐัะธั ัะตัะตะท Telegram ะธัะฟะพะปัะทัะตั **OAuth 2.0** ะฟัะพัะพะบะพะป. ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฒะฒะพะดะธั ะฟะฐัะพะปั ะฒ ะฒะฐัะตะผ ะฟัะธะปะพะถะตะฝะธะธ, ะฐ ะดะพะฒะตััะตั Telegram ะธะดะตะฝัะธัะธัะธัะพะฒะฐัั ะตะณะพ ะปะธัะฝะพััั.

---

## ๐ ะะพะปะฝะฐั ััะตะผะฐ ะฐะฒัะพัะธะทะฐัะธะธ

```
โโโโโโโโโโโ         โโโโโโโโโโโ         โโโโโโโโโโโโ         โโโโโโโโโโโโ
โ ะะปะธะตะฝั  โ         โ Gateway โ         โ   Auth   โ         โ Telegram โ
โ(ะัะฐัะทะตั)โ         โ Service โ         โ Service  โ         โ  Server  โ
โโโโโโฌโโโโโ         โโโโโโฌโโโโโ         โโโโโโฌโโโโโโ         โโโโโโฌโโโโโโ
     โ                   โ                   โ                     โ
     โ โโโโโโโโโโโโ ะจะะ 1: ะะะะฃะงะะะะ URL โโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                   โ                   โ                     โ
     โ GET /auth/telegramโ                   โ                     โ
     โโโโโโโโโโโโโโโโโโโโบโ                   โ                     โ
     โ                   โ gRPC TelegramInit โ                     โ
     โ                   โโโโโโโโโโโโโโโโโโโโบโ                     โ
     โ                   โ                   โ ะะตะฝะตัะฐัะธั URL       โ
     โ                   โ                   โ ั ะฟะฐัะฐะผะตััะฐะผะธ ะฑะพัะฐ  โ
     โ                   โ                   โ                     โ
     โ                   โ { url: "https://oauth.telegram.org/..." }
     โ                   โโโโโโโโโโโโโโโโโโโโโค                     โ
     โ { url: "..." }    โ                   โ                     โ
     โโโโโโโโโโโโโโโโโโโโโค                   โ                     โ
     โ                   โ                   โ                     โ
     โ โโโโโโโโโโโโ ะจะะ 2: ะะะะะะะะข ะะ TELEGRAM โโโโโโโโโโโโโโโโโโ
     โ                   โ                   โ                     โ
     โ ะะพะปัะทะพะฒะฐัะตะปั ะบะปะธะบะฐะตั ะฝะฐ ัััะปะบั        โ                     โ
     โ ะัะฐัะทะตั ะพัะบััะฒะฐะตั Telegram OAuth      โ                     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโบโ
     โ                   โ                   โ   GET /auth?bot_id=...
     โ                   โ                   โ                     โ
     โ                   โ                   โ   Telegram ะฟะพะบะฐะทัะฒะฐะตั:
     โ                   โ                   โ   "ะัะธะปะพะถะตะฝะธะต X ัะพัะตั
     โ                   โ                   โ    ะฟะพะปััะธัั ะฒะฐัะธ ะดะฐะฝะฝัะต"
     โ                   โ                   โ   [ะะฐะทัะตัะธัั] [ะัะผะตะฝะฐ]
     โ                   โ                   โ                     โ
     โ โโโโโโโโโโโโ ะจะะ 3: ะะะะขะะะะะะะะะ โโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                   โ                   โ                     โ
     โ ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "ะะฐะทัะตัะธัั"     โ                     โ
     โ                   โ                   โ                     โ
     โ Telegram ัะตะดะธัะตะบัะธั ะพะฑัะฐัะฝะพ ะฝะฐ ะฒะฐั ัะฐะนั ั ะดะฐะฝะฝัะผะธ           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ GET https://yoursite.com/callback?                          โ
     โ     id=123456&                                              โ
     โ     first_name=John&                                        โ
     โ     username=john_doe&                                      โ
     โ     hash=abc123...                                          โ
     โ                   โ                   โ                     โ
     โ โโโโโโโโโโโโ ะจะะ 4: ะะะะะคะะะะฆะะฏ โโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                   โ                   โ                     โ
     โ POST /auth/telegram/verify            โ                     โ
     โ Body: { tgAuthResult: "base64(json)" }  โ                   โ
     โโโโโโโโโโโโโโโโโโโโบโ                   โ                     โ
     โ                   โ JSON.parse(atob()) โ                     โ
     โ                   โ ะดะตะบะพะดะธััะตั ะดะฐะฝะฝัะต  โ                     โ
     โ                   โ                   โ                     โ
     โ                   โ gRPC TelegramVerify                     โ
     โ                   โ { query: {...} }  โ                     โ
     โ                   โโโโโโโโโโโโโโโโโโโโบโ                     โ
     โ                   โ                   โ 1. ะัะพะฒะตัะบะฐ hash    โ
     โ                   โ                   โ    (ะฟะพะดะฟะธัั ะพั TG)  โ
     โ                   โ                   โ 2. ะะพะธัะบ/ัะพะทะดะฐะฝะธะต   โ
     โ                   โ                   โ    ะฟะพะปัะทะพะฒะฐัะตะปั     โ
     โ                   โ                   โ 3. ะะตะฝะตัะฐัะธั ัะพะบะตะฝะพะฒโ
     โ                   โ                   โ                     โ
     โ                   โ { accessToken, refreshToken, user }     โ
     โ                   โโโโโโโโโโโโโโโโโโโโโค                     โ
     โ { accessToken, user }                 โ                     โ
     โ + Cookie: refreshToken                โ                     โ
     โโโโโโโโโโโโโโโโโโโโโค                   โ                     โ
     โ                   โ                   โ                     โ
     โ โ ะะฒัะพัะธะทะพะฒะฐะฝ!   โ                   โ                     โ
```

---

## ๐ฏ ะะฐัะตะผ ะฝัะถะตะฝ URL?

URL - ััะพ ะฐะดัะตั ัะฟะตัะธะฐะปัะฝะพะน ัััะฐะฝะธัั Telegram OAuth, ะณะดะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะดัะฒะตัะถะดะฐะตั, ััะพ ัะฐะทัะตัะฐะตั ะฒะฐัะตะผั ะฟัะธะปะพะถะตะฝะธั ะฟะพะปััะธัั ะตะณะพ ะดะฐะฝะฝัะต.

### **ะะพะผะฟะพะฝะตะฝัั URL:**

```typescript
const url = new URL("https://oauth.telegram.org/auth");

// ID ะฒะฐัะตะณะพ ะฑะพัะฐ
url.searchParams.append("bot_id", "7955980190");

// ะัะบัะดะฐ ะฟัะธัะตะป ะทะฐะฟัะพั (ะฒะฐั ัะฐะนั)
url.searchParams.append("origin", "https://yoursite.com");

// ะะฐะฟัะฐัะธะฒะฐะตะผ ะดะพัััะฟ ะบ ะดะฐะฝะฝัะผ ะฟะพะปัะทะพะฒะฐัะตะปั
url.searchParams.append("request_access", "write");

// ะัะดะฐ ะฒะตัะฝััั ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพัะปะต ะฐะฒัะพัะธะทะฐัะธะธ
url.searchParams.append("return_to", "https://yoursite.com");
```

---

## ๐ ะะตัะฐะปัะฝะพะต ะพะฟะธัะฐะฝะธะต ะบะฐะถะดะพะณะพ ัะฐะณะฐ

### **ะจะะ 1: ะะพะปััะตะฝะธะต URL ะพั ะฒะฐัะตะณะพ ัะตัะฒะตัะฐ**

**ะญะฝะดะฟะพะธะฝั:** `GET /auth/telegram`

**ะงัะพ ะฟัะพะธััะพะดะธั:**

```typescript
// telegram.service.ts
public getAuthUrl(): TelegramInitResponse {
  const url = new URL("https://oauth.telegram.org/auth");

  url.searchParams.append("bot_id", this.BOT_ID);
  url.searchParams.append("origin", this.REDIRECT_ORIGIN);
  url.searchParams.append("request_access", "write");
  url.searchParams.append("return_to", this.REDIRECT_ORIGIN);

  return { url: url.href };
}
```

**ะะตะทัะปััะฐั:**

```json
{
  "url": "https://oauth.telegram.org/auth?bot_id=7955980190&origin=https%3A%2F%2Fyoursite.com&request_access=write&return_to=https%3A%2F%2Fyoursite.com"
}
```

---

### **ะจะะ 2: ะะพะปัะทะพะฒะฐัะตะปั ะฟะตัะตัะพะดะธั ะฟะพ ัััะปะบะต**

**ะงัะพ ะฒะธะดะธั ะฟะพะปัะทะพะฒะฐัะตะปั:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Telegram OAuth                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                     โ
โ  ะัะธะปะพะถะตะฝะธะต "Cinema Tickets"       โ
โ  ัะพัะตั ะฟะพะปััะธัั ะดะพัััะฟ ะบ:          โ
โ                                     โ
โ  โ ะะฐัะต ะธะผั                        โ
โ  โ ะะฐั username                    โ
โ  โ ะะฐัะต ัะพัะพ ะฟัะพัะธะปั               โ
โ                                     โ
โ  [ะะฐะทัะตัะธัั]  [ะัะผะตะฝะฐ]             โ
โ                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### **ะจะะ 3: Telegram ะฒะพะทะฒัะฐัะฐะตั ะดะฐะฝะฝัะต**

**ะะพัะปะต ะฝะฐะถะฐัะธั "ะะฐะทัะตัะธัั", Telegram ัะตะดะธัะตะบัะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะพะฑัะฐัะฝะพ:**

```
https://yoursite.com/telegram-callback?
  id=123456789&
  first_name=John&
  last_name=Doe&
  username=john_doe&
  photo_url=https://...&
  auth_date=1708012345&
  hash=abc123def456...
```

**ะะฐะถะฝัะต ะฟะฐัะฐะผะตััั:**

- `id` - ัะฝะธะบะฐะปัะฝัะน ID ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ Telegram
- `first_name`, `last_name` - ะธะผั ะฟะพะปัะทะพะฒะฐัะตะปั
- `username` - @username ะฒ Telegram
- `photo_url` - ัััะปะบะฐ ะฝะฐ ะฐะฒะฐัะฐั
- `auth_date` - timestamp ะฐะฒัะพัะธะทะฐัะธะธ
- `hash` - **ะบัะธะฟัะพะณัะฐัะธัะตัะบะฐั ะฟะพะดะฟะธัั** ะพั Telegram

---

### **ะจะะ 4: ะะตัะธัะธะบะฐัะธั ะธ ัะพะทะดะฐะฝะธะต ัะตััะธะธ**

**ะญะฝะดะฟะพะธะฝั:** `POST /auth/telegram/verify`

**ะงัะพ ะฟัะพะธััะพะดะธั ะฒ ะบะพะดะต:**

#### **4.1. ะะตะบะพะดะธัะพะฒะฐะฝะธะต ะดะฐะฝะฝัั ะฒ Gateway:**

```typescript
@Post('telegram/verify')
public async telegramVerify(@Body() dto: TelegramVerifyRequest) {
  // ะะตะบะพะดะธััะตะผ base64 ะธ ะฟะฐััะธะผ JSON
  const query = JSON.parse(atob(dto.tgAuthResult));
  console.log('Telegram query:', query);

  // ะัะฟัะฐะฒะปัะตะผ ะฒ Auth Service ะดะปั ะฒะตัะธัะธะบะฐัะธะธ
  return this.authGrpcClient.telegramVerify({ query });
}
```

#### **4.2. ะะตัะธัะธะบะฐัะธั ะฒ Auth Service:**

```typescript
public async verifyAuth(query: Record<string, string>) {
  // 1. ะะะะะะะะ ะะะะะะกะ (hash)
  const dataCheckString = Object.keys(query)
    .filter(key => key !== 'hash')
    .sort()
    .map(key => `${key}=${query[key]}`)
    .join('\n');

  const secretKey = crypto
    .createHash('sha256')
    .update(this.BOT_TOKEN)
    .digest();

  const calculatedHash = crypto
    .createHmac('sha256', secretKey)
    .update(dataCheckString)
    .digest('hex');

  if (calculatedHash !== query.hash) {
    throw new Error("Invalid hash - data is fake!");
  }

  // 2. ะะะะะะะะ ะะะะะะะ (ะฝะต ััะฐััะต 24 ัะฐัะพะฒ)
  const authDate = parseInt(query.auth_date);
  if (Date.now() / 1000 - authDate > 86400) {
    throw new Error("Auth data expired");
  }

  // 3. ะะะะกะ ะะะ ะกะะะะะะะ ะะะะฌะะะะะขะะะฏ
  let user = await this.userRepo.findUserByTelegramId(query.id);

  if (!user) {
    user = await this.userRepo.createAccount({
      telegramId: query.id,
      username: query.username,
      firstName: query.first_name,
      lastName: query.last_name,
      photoUrl: query.photo_url,
      role: 'USER'
    });
  }

  // 4. ะะะะะะะฆะะฏ ะขะะะะะะ
  const { accessToken, refreshToken } =
    await this.passportService.generateTokenPair(user.id);

  return { accessToken, refreshToken, user };
}
```

---

## ๐ ะะพัะตะผั ััะพ ะฑะตะทะพะฟะฐัะฝะพ?

### **1. ะัะธะฟัะพะณัะฐัะธัะตัะบะฐั ะฟะพะดะฟะธัั (hash)**

- Telegram ะฟะพะดะฟะธััะฒะฐะตั ะดะฐะฝะฝัะต ัะตะบัะตัะฝัะผ ะบะปััะพะผ ะฒะฐัะตะณะพ ะฑะพัะฐ
- ะั ะฟัะพะฒะตััะตัะต ััั ะฟะพะดะฟะธัั ะฝะฐ ัะฒะพะตะผ ัะตัะฒะตัะต
- ะะตะฒะพะทะผะพะถะฝะพ ะฟะพะดะดะตะปะฐัั ะดะฐะฝะฝัะต ะฑะตะท ะทะฝะฐะฝะธั ัะตะบัะตัะฝะพะณะพ ะบะปััะฐ

**ะะฐะบ ัะฐะฑะพัะฐะตั ะฟะพะดะฟะธัั:**

```typescript
// Telegram ะดะตะปะฐะตั ััะพ ะฝะฐ ัะฒะพะตะน ััะพัะพะฝะต:
const hash = HMAC_SHA256(
  secret_key,
  "auth_date=1708012345\nfirst_name=John\nid=123456\nusername=john_doe",
);

// ะั ะดะตะปะฐะตัะต ััะพ ะฝะฐ ัะฒะพะตะน ััะพัะพะฝะต:
const calculatedHash = HMAC_SHA256(
  secret_key,
  "auth_date=1708012345\nfirst_name=John\nid=123456\nusername=john_doe",
);

// ะกัะฐะฒะฝะธะฒะฐะตะผ:
if (calculatedHash === receivedHash) {
  // โ ะะฐะฝะฝัะต ะฝะฐััะพััะธะต
} else {
  // โ ะะฐะฝะฝัะต ะฟะพะดะดะตะปะฐะฝั
}
```

### **2. ะัะตะผะตะฝะฝะฐั ะผะตัะบะฐ (auth_date)**

- ะะฐะฝะฝัะต ะดะตะนััะฒะธัะตะปัะฝั ัะพะปัะบะพ 24 ัะฐัะฐ
- ะะฐัะธัะฐ ะพั replay ะฐัะฐะบ (ะฟะพะฒัะพัะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ััะฐััั ะดะฐะฝะฝัั)

### **3. ะะธะบะฐะบะธั ะฟะฐัะพะปะตะน**

- ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฒะฒะพะดะธั ะฟะฐัะพะปั ะฒ ะฒะฐัะตะผ ะฟัะธะปะพะถะตะฝะธะธ
- Telegram ะณะฐัะฐะฝัะธััะตั, ััะพ ััะพ ัะตะฐะปัะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั

---

## ๐ ะกัััะบัััะฐ ะดะฐะฝะฝัั

### **DTO ะดะปั ะทะฐะฟัะพัะฐ ะฒะตัะธัะธะบะฐัะธะธ:**

```typescript
export class TelegramVerifyRequest {
  @ApiProperty({
    example:
      "eyJpZCI6NTI1MzY2Nzk0LCJmaXJzdF9uYW1lIjoiUnVzbGFuIiwidXNlcm5hbWUiOi...",
  })
  @IsString()
  @IsNotEmpty()
  public tgAuthResult: string; // base64 ะทะฐะบะพะดะธัะพะฒะฐะฝะฝัะน JSON ั query ะฟะฐัะฐะผะตััะฐะผะธ
}
```

### **ะกัััะบัััะฐ ะดะฐะฝะฝัั ะพั Telegram:**

```typescript
interface TelegramAuthData {
  id: string; // ะฃะฝะธะบะฐะปัะฝัะน ID ะฟะพะปัะทะพะฒะฐัะตะปั
  first_name: string; // ะะผั
  last_name?: string; // ะคะฐะผะธะปะธั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
  username?: string; // @username (ะพะฟัะธะพะฝะฐะปัะฝะพ)
  photo_url?: string; // URL ะฐะฒะฐัะฐัะฐ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
  auth_date: string; // Timestamp ะฐะฒัะพัะธะทะฐัะธะธ
  hash: string; // ะัะธะฟัะพะณัะฐัะธัะตัะบะฐั ะฟะพะดะฟะธัั
}
```

### **ะกัััะบัััะฐ ะพัะฒะตัะฐ:**

```typescript
interface TelegramVerifyResponse {
  accessToken: string;
  refreshToken: string;
  user: {
    id: string;
    telegramId: string;
    username?: string;
    firstName: string;
    lastName?: string;
    photoUrl?: string;
    role: "USER" | "ADMIN";
    createdAt: string;
    updatedAt: string;
  };
}
```

---

## ๐ก ะัะฐะบัะธัะตัะบะธะน ะฟัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฝะฐ ััะพะฝัะตะฝะดะต

### **1. ะะฝะธัะธะฐัะธั ะฐะฒัะพัะธะทะฐัะธะธ:**

```javascript
// ะะพะปััะฐะตะผ URL ะดะปั Telegram OAuth
const response = await fetch("/auth/telegram");
const { url } = await response.json();

// ะัะบััะฒะฐะตะผ popup ะดะปั ะฐะฒัะพัะธะทะฐัะธะธ
const popup = window.open(url, "telegram-auth", "width=600,height=600");
```

### **2. ะะฑัะฐะฑะพัะบะฐ callback ะพั Telegram:**

```javascript
// ะกะปััะฐะตะผ ัะพะพะฑัะตะฝะธั ะพั popup ะพะบะฝะฐ
window.addEventListener("message", async (event) => {
  if (event.data.type === "telegram-callback") {
    try {
      // ะะพะดะธััะตะผ query ะฟะฐัะฐะผะตััั ะฒ base64
      const tgAuthResult = btoa(JSON.stringify(event.data.query));

      // ะัะฟัะฐะฒะปัะตะผ ะฝะฐ ะฒะตัะธัะธะบะฐัะธั
      const authResponse = await fetch("/auth/telegram/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tgAuthResult }),
      });

      const { accessToken, user } = await authResponse.json();

      // ะกะพััะฐะฝัะตะผ ัะพะบะตะฝ ะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทะพะฒะฐะฝ!
      localStorage.setItem("accessToken", accessToken);
      console.log("User authorized:", user);

      // ะะฐะบััะฒะฐะตะผ popup
      popup.close();

      // ะะตะดะธัะตะบั ะฝะฐ ะณะปะฐะฒะฝัั ัััะฐะฝะธัั
      window.location.href = "/dashboard";
    } catch (error) {
      console.error("Telegram auth error:", error);
      popup.close();
    }
  }
});
```

### **3. ะ popup ะพะบะฝะต (telegram-callback.html):**

```html
<script>
  // ะะพะปััะฐะตะผ query ะฟะฐัะฐะผะตััั ะธะท URL
  const query = new URLSearchParams(window.location.search);
  const queryObject = Object.fromEntries(query.entries());

  // ะัะฟัะฐะฒะปัะตะผ ะดะฐะฝะฝัะต ะฒ ัะพะดะธัะตะปััะบะพะต ะพะบะฝะพ
  window.opener.postMessage(
    {
      type: "telegram-callback",
      query: queryObject,
    },
    window.location.origin,
  );

  // ะะฐะบััะฒะฐะตะผ popup
  window.close();
</script>
```

---

## โ๏ธ ะะพะทะผะพะถะฝัะต ะพัะธะฑะบะธ ะธ ะธั ัะตัะตะฝะธะต

### **1. Invalid hash - data is fake!**

**ะัะธัะธะฝะฐ:** ะะพะดะฟะธัั ะฝะต ัะพะฒะฟะฐะดะฐะตั
**ะะตัะตะฝะธะต:** ะัะพะฒะตัะธัั ะฟัะฐะฒะธะปัะฝะพััั ัะพัะผะธัะพะฒะฐะฝะธั dataCheckString ะธ ัะตะบัะตัะฝะพะณะพ ะบะปััะฐ

### **2. Auth data expired**

**ะัะธัะธะฝะฐ:** ะะฐะฝะฝัะต ััะฐััะต 24 ัะฐัะพะฒ
**ะะตัะตะฝะธะต:** ะะพะปัะทะพะฒะฐัะตะปั ะดะพะปะถะตะฝ ะทะฐะฝะพะฒะพ ะฐะฒัะพัะธะทะพะฒะฐัััั

### **3. Bot token invalid**

**ะัะธัะธะฝะฐ:** ะะตะฒะตัะฝัะน ัะพะบะตะฝ ะฑะพัะฐ
**ะะตัะตะฝะธะต:** ะัะพะฒะตัะธัั ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั `TELEGRAM_BOT_TOKEN`

### **4. CORS ะพัะธะฑะบะธ**

**ะัะธัะธะฝะฐ:** Popup ะฝะต ะผะพะถะตั ะพัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต ะฒ ัะพะดะธัะตะปััะบะพะต ะพะบะฝะพ
**ะะตัะตะฝะธะต:** ะฃะฑะตะดะธัััั, ััะพ `window.location.origin` ัะพะฒะฟะฐะดะฐะตั

---

## ๐๏ธ ะะฐัััะพะนะบะฐ ะพะบััะถะตะฝะธั

### **ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**

```env
# Telegram Bot Settings
TELEGRAM_BOT_ID=7955980190
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_BOT_USERNAME=your_bot_username
TELEGRAM_REDIRECT_ORIGIN=https://yoursite.com
```

### **ะกะพะทะดะฐะฝะธะต Telegram ะฑะพัะฐ:**

1. ะะฐะนะดะธัะต @BotFather ะฒ Telegram
2. ะัะฟัะฐะฒััะต `/newbot`
3. ะกะปะตะดัะนัะต ะธะฝััััะบัะธัะผ
4. ะะพะปััะธัะต `BOT_ID` ะธ `BOT_TOKEN`
5. ะะฐัััะพะนัะต `BOT_USERNAME`

---

## ๐ ะงะตะบะปะธัั ัะตะฐะปะธะทะฐัะธะธ

- [ ] ะกะพะทะดะฐัั Telegram ะฑะพัะฐ ัะตัะตะท @BotFather
- [ ] ะะพะฑะฐะฒะธัั ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- [ ] ะะตะฐะปะธะทะพะฒะฐัั `GET /auth/telegram` (ะฟะพะปััะตะฝะธะต URL)
- [ ] ะะตะฐะปะธะทะพะฒะฐัั `POST /auth/telegram/verify` (ะฒะตัะธัะธะบะฐัะธั)
- [ ] ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั hash ะฒ Auth Service
- [ ] ะะพะฑะฐะฒะธัั ะปะพะณะธะบั ัะพะทะดะฐะฝะธั/ะฟะพะธัะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
- [ ] ะะฐัััะพะธัั ััะพะฝัะตะฝะด ะดะปั popup ะฐะฒัะพัะธะทะฐัะธะธ
- [ ] ะะพะฑะฐะฒะธัั ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ
- [ ] ะขะตััะธัะพะฒะฐัั ะฟะพะปะฝัะน ัะธะบะป ะฐะฒัะพัะธะทะฐัะธะธ

---

## ๐ฏ ะัะตะธะผััะตััะฒะฐ Telegram OAuth

### **ะะปั ะฟะพะปัะทะพะฒะฐัะตะปั:**

- โ ะะต ะฝัะถะฝะพ ัะตะณะธัััะธัะพะฒะฐัััั
- โ ะะต ะฝัะถะฝะพ ะทะฐะฟะพะผะธะฝะฐัั ะฟะฐัะพะปั
- โ ะะดะธะฝ ะบะปะธะบ ะดะปั ะฐะฒัะพัะธะทะฐัะธะธ
- โ ะะพะฒะตัะธะต ะบ Telegram

### **ะะปั ัะฐะทัะฐะฑะพััะธะบะฐ:**

- โ ะะตั ััะฐะฝะตะฝะธั ะฟะฐัะพะปะตะน
- โ ะะตะฝััะต ะบะพะดะฐ ะดะปั ัะตะณะธัััะฐัะธะธ
- โ ะััะพะบะฐั ะฑะตะทะพะฟะฐัะฝะพััั
- โ ะะณะฝะพะฒะตะฝะฝะฐั ะฐะฒัะพัะธะทะฐัะธั

---

## ๐ ะะปััะตัะฝะฐัะธะฒะฝัะต ััะตะฝะฐัะธะธ

### **1. ะัะธะฒัะทะบะฐ Telegram ะบ ัััะตััะฒัััะตะผั ะฐะบะบะฐัะฝัั:**

```typescript
// ะะพะปัะทะพะฒะฐัะตะปั ัะถะต ะฐะฒัะพัะธะทะพะฒะฐะฝ ะฟะพ email/phone
// ะ ัะพัะตั ะฟัะธะฒัะทะฐัั Telegram ะดะปั ัะดะพะฑะฝะพะณะพ ะฒัะพะดะฐ

POST / account / telegram / link;
Body: {
  tgAuthResult: "base64(...)";
}

// ะะพะณะธะบะฐ:
// 1. ะะตัะธัะธัะธััะตะผ ะดะฐะฝะฝัะต Telegram
// 2. ะะฐัะพะดะธะผ ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพ userId ะธะท ัะพะบะตะฝะฐ
// 3. ะะฑะฝะพะฒะปัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั: telegramId = tg.id
// 4. ะะพะทะฒัะฐัะฐะตะผ ััะฟะตั
```

### **2. ะัะพะด ัะตัะตะท Telegram ะฒะผะตััะพ email/phone:**

```typescript
// ะะพะปะฝะฐั ะทะฐะผะตะฝะฐ email/phone ะฐะฒัะพัะธะทะฐัะธะธ
// ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะฒะพะนัะธ ัะพะปัะบะพ ัะตัะตะท Telegram

// ะัะตะธะผััะตััะฒะฐ:
// - ะะตั ะฝะตะพะฑัะพะดะธะผะพััะธ ะฒ email/phone
// - ะะณะฝะพะฒะตะฝะฝะฐั ัะตะณะธัััะฐัะธั
// - ะััะพะบะฐั ะฑะตะทะพะฟะฐัะฝะพััั
```

---

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะตััััั

### **ะัะธัะธะฐะปัะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั Telegram:**

---

## ๐ **ะะพะปะฝัะน ะฟัะพัะตัั ะฐะฒัะพัะธะทะฐัะธะธ ัะตัะตะท Telegram (ะฟะพัะฐะณะพะฒะพ)**

### **ะจะฐะณ 1: ะะฝะธัะธะฐะปะธะทะฐัะธั ะฐะฒัะพัะธะทะฐัะธะธ (Frontend โ Gateway โ Auth)**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะบะฝะพะฟะบั "ะะพะนัะธ ัะตัะตะท Telegram" ะฝะฐ ััะพะฝัะตะฝะดะต
2. Frontend ะพัะฟัะฐะฒะปัะตั `GET /auth/telegram` ะฝะฐ Gateway Service
3. Gateway ะฒัะทัะฒะฐะตั gRPC ะผะตัะพะด `TelegramInit()` ะฒ Auth Service
4. Auth Service ะณะตะฝะตัะธััะตั OAuth URL ะดะปั Telegram

**ะะพะด:**

```typescript
// gateway-service/src/modules/auth/auth.controller.ts:137-141
@Get('telegram')
public async telegramInit() {
  return this.authGrpcClient.telegramInit()
}

// auth-service/src/modules/telegram/telegram.service.ts:44-62
public getAuthUrl(): TelegramInitResponse {
  const url = new URL(`https://oauth.telegram.org/auth`);
  url.searchParams.append("bot_id", this.BOT_ID);
  url.searchParams.append("origin", this.REDIRECT_ORIGIN);
  url.searchParams.append("request_access", "write");
  url.searchParams.append("return_to", this.REDIRECT_ORIGIN);
  return { url: url.href };
}
```

**ะะตะทัะปััะฐั:** Frontend ะฟะพะปััะฐะตั URL ะฒะธะดะฐ:

```
https://oauth.telegram.org/auth?bot_id=8415500619&origin=https://yoursite.com&request_access=write&return_to=https://yoursite.com
```

---

### **ะจะฐะณ 2: OAuth ะฐะฒัะพัะธะทะฐัะธั ะฒ Telegram**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. Frontend ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ ะฟะพะปััะตะฝะฝัะน URL
2. ะะพะปัะทะพะฒะฐัะตะปั ะพัะบััะฒะฐะตั Telegram OAuth ัััะฐะฝะธัั
3. Telegram ะฟะพะบะฐะทัะฒะฐะตั ะธะฝัะพัะผะฐัะธั ะพ ะฑะพัะต ะธ ะทะฐะฟัะฐัะธะฒะฐะตั ัะฐะทัะตัะตะฝะธะต
4. ะะพะปัะทะพะฒะฐัะตะปั ะฟะพะดัะฒะตัะถะดะฐะตั ะฐะฒัะพัะธะทะฐัะธั
5. Telegram ะฒะพะทะฒัะฐัะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ `return_to` URL ั ะฟะฐัะฐะผะตััะฐะผะธ ะฒ hash

**ะะฐัะฐะผะตััั ะฒ URL hash:**

```
#tgAuthResult=base64({
  id: "525366794",
  first_name: "Ruslan",
  username: "Ruslan_Kralin",
  auth_date: "1771151026",
  hash: "abc123..."
})
```

---

### **ะจะฐะณ 3: ะะตัะธัะธะบะฐัะธั Telegram ะดะฐะฝะฝัั (Frontend โ Gateway โ Auth)**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. Frontend ะธะทะฒะปะตะบะฐะตั `tgAuthResult` ะธะท URL hash
2. Frontend ะพัะฟัะฐะฒะปัะตั `POST /auth/telegram/verify` ั ะดะฐะฝะฝัะผะธ ะฝะฐ Gateway
3. Gateway ะดะตะบะพะดะธััะตั base64 ะธ ะพัะฟัะฐะฒะปัะตั ะดะฐะฝะฝัะต ะฒ Auth Service
4. Auth Service ะฟัะพะฒะตััะตั ะฟะพะดะปะธะฝะฝะพััั ะดะฐะฝะฝัั ัะตัะตะท HMAC

**ะะพะด:**

```typescript
// gateway-service/src/modules/auth/auth.controller.ts:143-157
@Post('telegram/veryfy')
public async telegramVerify(@Body() dto: TelegramVerifyRequest) {
  const query = JSON.parse(atob(dto.tgAuthResult))
  const result = await this.authGrpcClient.telegramVerify({ query })

  if ('url' in result && result.url) {
    return result  // ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั - ะฝัะถะตะฝ ะฝะพะผะตั ัะตะปะตัะพะฝะฐ
  }
  // ะกััะตััะฒัััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั - ะฒะพะทะฒัะฐัะฐะตะผ ัะพะบะตะฝั
}

// auth-service/src/modules/telegram/telegram.service.ts:94-115
private checkTelegramAuth(query: Record<string, string>) {
  const hash = query.hash;
  const dataCheckArr = Object.keys(query)
    .filter((key) => key !== "hash")
    .sort()
    .map((k) => `${k}=${query[k]}`);

  const dataCheckStr = dataCheckArr.join("\n");
  const secretKey = createHash("sha256")
    .update(`${this.BOT_ID}:${this.BOT_TOKEN}`)
    .digest();
  const hmac = createHmac("sha256", secretKey)
    .update(dataCheckStr)
    .digest("hex");

  return hmac === hash;  // ะัะพะฒะตัะบะฐ ะฟะพะดะปะธะฝะฝะพััะธ
}
```

---

### **ะจะฐะณ 4A: ะกััะตััะฒัััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั (Auth)**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. Auth Service ะฟัะพะฒะตััะตั ะฝะฐะปะธัะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพ `telegramId`
2. ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐะนะดะตะฝ ะ ั ะฝะตะณะพ ะตััั ะฝะพะผะตั ัะตะปะตัะพะฝะฐ โ ะณะตะฝะตัะธัััััั ัะพะบะตะฝั
3. Gateway ัััะฐะฝะฐะฒะปะธะฒะฐะตั `refreshToken` ะฒ cookie
4. Frontend ะฟะพะปััะฐะตั `accessToken`

**ะะพะด:**

```typescript
// auth-service/src/modules/telegram/telegram.service.ts:72-79
const existingUser =
  await this.telegramRepository.findUserByTelegramId(telegramId);

if (existingUser && existingUser.phone) {
  return this.tokenService.generateTokens(existingUser.id);
}
```

**ะะตะทัะปััะฐั:** ะะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทะพะฒะฐะฝ โ

---

### **ะจะฐะณ 4B: ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั - ัะพะทะดะฐะฝะธะต ัะตััะธะธ (Auth โ Redis)**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฝะฐะนะดะตะฝ ะะะ ั ะฝะตะณะพ ะฝะตั ะฝะพะผะตัะฐ ัะตะปะตัะพะฝะฐ
2. Auth Service ะณะตะฝะตัะธััะตั ัะฝะธะบะฐะปัะฝัะน `sessionId` (32 ัะธะผะฒะพะปะฐ hex)
3. ะะฐะฝะฝัะต Telegram ัะพััะฐะฝััััั ะฒ Redis ั TTL 5 ะผะธะฝัั
4. ะะพะทะฒัะฐัะฐะตััั URL ะดะปั ะฟะตัะตัะพะดะฐ ะฒ ะฑะพั ั ะฟะฐัะฐะผะตััะพะผ `start`

**ะะพะด:**

```typescript
// auth-service/src/modules/telegram/telegram.service.ts:80-91
const sessionId = randomBytes(16).toString("hex");
await this.redisService.set(
  `telegram_session:${sessionId}`,
  JSON.stringify({
    telegramId,
    username: data.query.username,
  }),
  "EX",
  300, // 5 ะผะธะฝัั
);
return { url: `http://t.me/${this.BOT_USERNAME}?start=${sessionId}` };
```

**ะะตะทัะปััะฐั:** Frontend ะฟะพะปััะฐะตั:

```json
{
  "url": "http://t.me/ticket_987_for_cinema_bot?start=a1b2c3d4e5f6..."
}
```

---

### **ะจะฐะณ 5: ะะตัะตัะพะด ะฒ Telegram ะฑะพั**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. Frontend ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ URL ะฑะพัะฐ
2. Telegram ะพัะบััะฒะฐะตััั ั ะฑะพัะพะผ ะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะฟัะฐะฒะปัะตั `/start a1b2c3d4e5f6...`
3. ะะพั ะฟะพะปััะฐะตั ะบะพะผะฐะฝะดั ั ะฟะฐัะฐะผะตััะพะผ `sessionId`

---

### **ะจะฐะณ 6: ะะฑัะฐะฑะพัะบะฐ /start ะฒ ะฑะพัะต**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. ะะพั ะฟะพะปััะฐะตั ะบะพะผะฐะฝะดั `/start` ั ะฟะฐัะฐะผะตััะพะผ `sessionId`
2. ะกะพััะฐะฝัะตั `sessionId` ะฒ ัะตััะธั ะฟะพะปัะทะพะฒะฐัะตะปั
3. ะัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต ั ะบะฝะพะฟะบะพะน "ะัะฟัะฐะฒะธัั ะฝะพะผะตั"

**ะะพะด:**

```typescript
// bot-service/src/modules/bot/handlers/start.handler.ts:3-22
export const registerStartHandler = (bot: Telegraf) => {
  bot.start(async (ctx) => {
    const sessionId = ctx.startPayload; // "a1b2c3d4e5f6..."

    if (!(ctx as any).session) {
      (ctx as any).session = {};
    }

    if (sessionId) {
      (ctx as any).session.id = sessionId; // ะกะพััะฐะฝัะตะผ ะฒ ัะตััะธั
    }

    await ctx.reply(
      "ะะปั ะทะฐะฒะตััะตะฝะธั ะฐะฒัะพัะธะทะฐัะธะธ ะพัะฟัะฐะฒัะต ัะฒะพะน ะฝะพะผะตั ัะตะปะตัะพะฝะฐ",
      Markup.keyboard([[Markup.button.contactRequest("ะัะฟัะฐะฒะธัั ะฝะพะผะตั")]])
        .resize()
        .oneTime(),
    );
  });
};
```

**ะะตะทัะปััะฐั:** ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ัะพะพะฑัะตะฝะธะต ั ะบะฝะพะฟะบะพะน ะดะปั ะพัะฟัะฐะฒะบะธ ะบะพะฝัะฐะบัะฐ

---

### **ะจะฐะณ 7: ะัะฟัะฐะฒะบะฐ ะฝะพะผะตัะฐ ัะตะปะตัะพะฝะฐ**

**ะงัะพ ะฟัะพะธััะพะดะธั:**

1. ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะบะฝะพะฟะบั "ะัะฟัะฐะฒะธัั ะฝะพะผะตั"
2. Telegram ะพัะฟัะฐะฒะปัะตั ะบะพะฝัะฐะบั ะฑะพัั
3. ะะพั ะฟะพะปััะฐะตั ัะพะฑััะธะต `contact` ั ะฝะพะผะตัะพะผ ัะตะปะตัะพะฝะฐ
4. ะะพั ะธะทะฒะปะตะบะฐะตั `sessionId` ะธะท ัะตััะธะธ ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะพะด:**

```typescript
// bot-service/src/modules/bot/handlers/contact.handler.ts:3-13
export const registerContactHandler = (bot: Telegraf) => {
  bot.on("contact", async (ctx) => {
    const phone = ctx.message.contact.phone_number; // "+375297888192"

    console.log("ะะพะปััะตะฝ ะฝะพะผะตั ัะตะปะตัะพะฝะฐ:", phone);

    await ctx.reply(
      `โ ะกะฟะฐัะธะฑะพ! ะะฐั ะฝะพะผะตั ัะตะปะตัะพะฝะฐ ะฟะพะปััะตะฝ: ${phone}\n\nะะฒัะพัะธะทะฐัะธั ะทะฐะฒะตััะตะฝะฐ!`,
    );
  });
};
```

**ะะตะทัะปััะฐั:**

- ะะพะฝัะพะปั: `ะะพะปััะตะฝ ะฝะพะผะตั ัะตะปะตัะพะฝะฐ: +375297888192`
- Telegram: `โ ะกะฟะฐัะธะฑะพ! ะะฐั ะฝะพะผะตั ัะตะปะตัะพะฝะฐ ะฟะพะปััะตะฝ: +375297888192`

---

### **ะจะฐะณ 8: ะกะฒัะทัะฒะฐะฝะธะต ะฝะพะผะตัะฐ ั ะฐะบะบะฐัะฝัะพะผ (Bot โ Auth โ Database)**

**โ๏ธ ะขะะะฃะฉะะ ะกะะกะขะะฏะะะ:** ะญัะพั ัะฐะณ **ะะ ะะะะะะะะะะ** ะฒ ะบะพะดะต!

**ะงัะพ ะะะะะะ ะฟัะพะธััะพะดะธัั:**

1. ะะพั ะธะทะฒะปะตะบะฐะตั `sessionId` ะธะท ัะตััะธะธ
2. ะะพั ะพัะฟัะฐะฒะปัะตั gRPC ะทะฐะฟัะพั ะฒ Auth Service ั `sessionId` ะธ `phone`
3. Auth Service:
   - ะะพะปััะฐะตั ะดะฐะฝะฝัะต ะธะท Redis ะฟะพ ะบะปััั `telegram_session:${sessionId}`
   - ะะทะฒะปะตะบะฐะตั `telegramId` ะธ `username`
   - ะกะพะทะดะฐะตั ะธะปะธ ะพะฑะฝะพะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะะ ั ะฝะพะผะตัะพะผ ัะตะปะตัะพะฝะฐ
   - ะะตะฝะตัะธััะตั ัะพะบะตะฝั
   - ะะพะทะฒัะฐัะฐะตั ัะพะบะตะฝั ะฑะพัั
4. ะะพั ะพัะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ัััะปะบั ะดะปั ะฒะพะทะฒัะฐัะฐ ะฝะฐ ัะฐะนั ั ัะพะบะตะฝะฐะผะธ

**ะะพะด, ะบะพัะพััะน ะะฃะะะ ะดะพะฑะฐะฒะธัั:**

```typescript
// bot-service/src/modules/bot/handlers/contact.handler.ts
export const registerContactHandler = (bot: Telegraf) => {
  bot.on("contact", async (ctx) => {
    const phone = ctx.message.contact.phone_number;
    const sessionId = (ctx as any).session?.id;

    if (!sessionId) {
      await ctx.reply("โ ะัะธะฑะบะฐ: ัะตััะธั ะฝะต ะฝะฐะนะดะตะฝะฐ. ะะฐัะฝะธัะต ะทะฐะฝะพะฒะพ ั /start");
      return;
    }

    // TODO: ะัะฟัะฐะฒะธัั gRPC ะทะฐะฟัะพั ะฒ auth-service
    const result = await authGrpcClient.completePhoneAuth({
      sessionId,
      phone,
    });

    if (result.success) {
      await ctx.reply(
        `โ ะะฒัะพัะธะทะฐัะธั ะทะฐะฒะตััะตะฝะฐ!\n\nะะตัะฝะธัะตัั ะฝะฐ ัะฐะนั ะดะปั ะฟัะพะดะพะปะถะตะฝะธั.`,
        Markup.inlineKeyboard([
          [
            Markup.button.url(
              "ะะตัะฝััััั ะฝะฐ ัะฐะนั",
              `${FRONTEND_URL}/auth/callback?token=${result.accessToken}`,
            ),
          ],
        ]),
      );
    }
  });
};
```

---

## ๐ **ะัะพะณะพะฒะฐั ััะตะผะฐ ะฟะพัะพะบะฐ ะดะฐะฝะฝัั**

```
โโโโโโโโโโโโโโโ
โ  Frontend   โ
โโโโโโโโฌโโโโโโโ
       โ 1. GET /auth/telegram
       โผ
โโโโโโโโโโโโโโโ
โ   Gateway   โ
โโโโโโโโฌโโโโโโโ
       โ 2. gRPC TelegramInit()
       โผ
โโโโโโโโโโโโโโโ
โAuth Service โ โ ะะตะฝะตัะธััะตั OAuth URL
โโโโโโโโฌโโโโโโโ
       โ 3. ะะพะทะฒัะฐัะฐะตั URL
       โผ
โโโโโโโโโโโโโโโ
โ  Frontend   โ โ ะะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฝะฐ Telegram OAuth
โโโโโโโโฌโโโโโโโ
       โ 4. ะะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพัะธะทัะตััั
       โผ
โโโโโโโโโโโโโโโ
โ  Telegram   โ โ ะะพะทะฒัะฐัะฐะตั ะฝะฐ ัะฐะนั ั hash
โโโโโโโโฌโโโโโโโ
       โ 5. POST /auth/telegram/verify
       โผ
โโโโโโโโโโโโโโโ
โ   Gateway   โ
โโโโโโโโฌโโโโโโโ
       โ 6. gRPC TelegramVerify()
       โผ
โโโโโโโโโโโโโโโ
โAuth Service โ โ ะัะพะฒะตััะตั HMAC
โโโโโโโโฌโโโโโโโ
       โ
       โโ ะะพะปัะทะพะฒะฐัะตะปั ัััะตััะฒัะตั โ ะะพะทะฒัะฐัะฐะตั ัะพะบะตะฝั โ
       โ
       โโ ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั:
          โ 7. ะกะพะทะดะฐะตั sessionId
          โ 8. ะกะพััะฐะฝัะตั ะฒ Redis
          โผ
       โโโโโโโโโโโโโโโ
       โ    Redis    โ telegram_session:abc123 โ {telegramId, username}
       โโโโโโโโโโโโโโโ
          โ 9. ะะพะทะฒัะฐัะฐะตั URL ะฑะพัะฐ
          โผ
       โโโโโโโโโโโโโโโ
       โ  Frontend   โ โ ะะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฒ Telegram ะฑะพั
       โโโโโโโโฌโโโโโโโ
              โ 10. /start sessionId
              โผ
       โโโโโโโโโโโโโโโ
       โ Telegram Botโ โ ะกะพััะฐะฝัะตั sessionId ะฒ ัะตััะธั
       โโโโโโโโฌโโโโโโโ
              โ 11. ะะพะบะฐะทัะฒะฐะตั ะบะฝะพะฟะบั "ะัะฟัะฐะฒะธัั ะฝะพะผะตั"
              โผ
       โโโโโโโโโโโโโโโ
       โ    User     โ โ ะะฐะถะธะผะฐะตั ะบะฝะพะฟะบั
       โโโโโโโโฌโโโโโโโ
              โ 12. ะัะฟัะฐะฒะปัะตั ะบะพะฝัะฐะบั
              โผ
       โโโโโโโโโโโโโโโ
       โ Telegram Botโ โ ะะพะปััะฐะตั ะฝะพะผะตั ัะตะปะตัะพะฝะฐ
       โโโโโโโโฌโโโโโโโ
              โ 13. โ๏ธ ะะฃะะะ: gRPC CompletePhoneAuth()
              โผ
       โโโโโโโโโโโโโโโ
       โAuth Service โ โ ะกะพะทะดะฐะตั/ะพะฑะฝะพะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั
       โโโโโโโโฌโโโโโโโ   โ ะะตะฝะตัะธััะตั ัะพะบะตะฝั
              โ
              โผ
       โโโโโโโโโโโโโโโ
       โ  Database   โ โ ะกะพััะฐะฝัะตั user ั phone ะธ telegramId
       โโโโโโโโโโโโโโโ
```

---

## โ๏ธ **ะงัะพ ะะ ะะะะะะะะะะะ:**

1. **gRPC ะผะตัะพะด `CompletePhoneAuth` ะฒ Auth Service** - ะดะปั ัะฒัะทัะฒะฐะฝะธั ะฝะพะผะตัะฐ ัะตะปะตัะพะฝะฐ ั Telegram ะฐะบะบะฐัะฝัะพะผ
2. **gRPC ะบะปะธะตะฝั ะฒ Bot Service** - ะดะปั ะพัะฟัะฐะฒะบะธ ะทะฐะฟัะพัะพะฒ ะฒ Auth Service
3. **ะะฑัะฐะฑะพัะบะฐ ัะพะบะตะฝะพะฒ ะฒ ะฑะพัะต** - ะฒะพะทะฒัะฐั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ ัะฐะนั ั ัะพะบะตะฝะฐะผะธ
4. **ะะฑัะฐะฑะพัะบะฐ callback ะฝะฐ ััะพะฝัะตะฝะดะต** - ะฟัะธะตะผ ัะพะบะตะฝะพะฒ ะธ ะทะฐะฒะตััะตะฝะธะต ะฐะฒัะพัะธะทะฐัะธะธ

---

## โ **ะงัะพ ะะะะะขะะะข:**

1. โ ะะตะฝะตัะฐัะธั OAuth URL ะดะปั Telegram
2. โ ะะตัะธัะธะบะฐัะธั Telegram ะดะฐะฝะฝัั ัะตัะตะท HMAC
3. โ ะกะพะทะดะฐะฝะธะต ะฒัะตะผะตะฝะฝะพะน ัะตััะธะธ ะฒ Redis
4. โ ะะพะปััะตะฝะธะต ะฝะพะผะตัะฐ ัะตะปะตัะพะฝะฐ ัะตัะตะท ะฑะพัะฐ
5. โ ะะฒัะพัะธะทะฐัะธั ัััะตััะฒัััะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

---

ะญัะพ ะฟะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ ะฟะพ ัะตะฐะปะธะทะฐัะธะธ ะฐะฒัะพัะธะทะฐัะธะธ ัะตัะตะท Telegram ะฒ ะฒะฐัะตะผ ะฟัะพะตะบัะต! ๐
