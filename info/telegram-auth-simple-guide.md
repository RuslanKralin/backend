# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram - –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º

## üéØ –û–±—â–∞—è –∏–¥–µ—è

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–æ–π—Ç–∏ –≤ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä, –Ω–æ –≤–º–µ—Å—Ç–æ –±–∏–ª–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å–≤–æ–π Telegram –∞–∫–∫–∞—É–Ω—Ç.

---

## ÔøΩ –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á - –æ—Å–Ω–æ–≤–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### **–û—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è BOT_TOKEN:**

**BOT_TOKEN - —ç—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞—é—Ç —Ç–æ–ª—å–∫–æ Telegram –∏ –≤–∞—à —Å–µ—Ä–≤–µ—Ä!**

#### **–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –≤ Telegram**

1. **–ò–¥–µ—Ç–µ –≤ @BotFather –≤ Telegram**
2. **–ü–∏—à–µ—Ç–µ `/newbot`**
3. **–î–∞–µ—Ç–µ –∏–º—è –±–æ—Ç—É:** "My Cinema Bot"
4. **–î–∞–µ—Ç–µ username:** "my_cinema_bot"
5. **–ü–æ–ª—É—á–∞–µ—Ç–µ BOT_TOKEN:** `123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`

**BOT_TOKEN —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:**

```
123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
    ‚Üë              ‚Üë
  BOT_ID      –°–µ–∫—Ä–µ—Ç–Ω–∞—è —á–∞—Å—Ç—å
```

#### **–®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –≤ .env —Ñ–∞–π–ª**

```bash
# .env —Ñ–∞–π–ª (–ù–ò–ö–û–ì–î–ê –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –≤ git!)
TELEGRAM_BOT_ID=123456789
TELEGRAM_BOT_TOKEN=123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
TELEGRAM_BOT_USERNAME=my_cinema_bot
TELEGRAM_REDIRECT_ORIGIN=https://your-site.com
```

#### **–®–∞–≥ 3: –°–µ—Ä–≤–µ—Ä —á–∏—Ç–∞–µ—Ç –∏–∑ .env**

```typescript
// TelegramService –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
constructor(private readonly configService: ConfigService<AllConfig>) {
  this.BOT_ID = this.configService.get("telegram.botId", { infer: true });
  this.BOT_TOKEN = this.configService.get("telegram.botToken", { infer: true });
  this.BOT_USERNAME = this.configService.get("telegram.botUsername", { infer: true });
  this.REDIRECT_ORIGIN = this.configService.get("telegram.redirectOrigin", { infer: true });
}
```

### **–ö—Ç–æ –∑–Ω–∞–µ—Ç BOT_TOKEN:**

‚úÖ **Telegram** - —Å–æ–∑–¥–∞–ª —Ç–æ–∫–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–æ—Ç–∞  
‚úÖ **–í–∞—à —Å–µ—Ä–≤–µ—Ä** - –ø—Ä–æ—á–∏—Ç–∞–ª –∏–∑ .env —Ñ–∞–π–ª–∞  
‚ùå **–ö–ª–∏–µ–Ω—Ç (–±—Ä–∞—É–∑–µ—Ä)** - –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω  
‚ùå **–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏** - –Ω–µ –º–æ–≥—É—Ç —É–∑–Ω–∞—Ç—å —Ç–æ–∫–µ–Ω

### **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω BOT_TOKEN:**

**–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –ø–æ–¥–ø–∏—Å–∏ (hash)!**

```
Telegram —Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å:
  –î–∞–Ω–Ω—ã–µ + BOT_TOKEN ‚Üí HMAC-SHA256 ‚Üí hash

–í–∞—à —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å:
  –î–∞–Ω–Ω—ã–µ + BOT_TOKEN ‚Üí HMAC-SHA256 ‚Üí hash

–ï—Å–ª–∏ hash —Å–æ–≤–ø–∞–¥–∞—é—Ç = –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ! ‚úÖ
```

---

## üîó –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è OAuth —Å—Å—ã–ª–∫–∞

### **–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏:**

#### **1. –ë–∞–∑–æ–≤—ã–π URL (–≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π):**

```typescript
const url = new URL(`https://oauth.telegram.org/auth`);
```

**–≠—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π OAuth endpoint Telegram - –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö.**

#### **2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ .env:**

**bot_id - ID –≤–∞—à–µ–≥–æ –±–æ—Ç–∞:**

```typescript
url.searchParams.append("bot_id", this.BOT_ID);
// –ò–∑ .env: TELEGRAM_BOT_ID=123456789
```

**origin - –≤–∞—à –¥–æ–º–µ–Ω:**

```typescript
url.searchParams.append("origin", this.REDIRECT_ORIGIN);
// –ò–∑ .env: TELEGRAM_REDIRECT_ORIGIN=https://your-site.com
```

**request_access - —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:**

```typescript
url.searchParams.append("request_access", "write");
// "write" = –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// "read" = —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
```

**return_to - –∫—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è:**

```typescript
url.searchParams.append("return_to", this.REDIRECT_ORIGIN);
// URL, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π Telegram –≤–µ—Ä–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

#### **3. –ì–æ—Ç–æ–≤–∞—è —Å—Å—ã–ª–∫–∞:**

```
https://oauth.telegram.org/auth?
  bot_id=123456789&
  origin=https://your-site.com&
  request_access=write&
  return_to=https://your-site.com
```

### **–ü—É—Ç—å —Å—Å—ã–ª–∫–∏ –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```
1. .env —Ñ–∞–π–ª (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
   ‚Üì
2. ConfigService —á–∏—Ç–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
   ‚Üì
3. TelegramService.getAuthUrl() —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç URL
   ‚Üì
4. TelegramController ‚Üí gRPC ‚Üí Gateway
   ‚Üì
5. Gateway –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON: { url: "https://..." }
   ‚Üì
6. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç URL
   ‚Üì
7. –ë—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç redirect –ø–æ —Å—Å—ã–ª–∫–µ
   ‚Üì
8. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Telegram OAuth
```

### **–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è:**

```typescript
// TelegramService.getAuthUrl()
public getAuthUrl(): TelegramInitResponse {
  // 1. –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π URL
  const url = new URL(`https://oauth.telegram.org/auth`);

  // 2. –î–æ–±–∞–≤–ª—è–µ–º ID –±–æ—Ç–∞ –∏–∑ .env
  url.searchParams.append("bot_id", this.BOT_ID);

  // 3. –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–º–µ–Ω –∏–∑ .env (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
  url.searchParams.append("origin", this.REDIRECT_ORIGIN);

  // 4. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
  url.searchParams.append("request_access", "write");

  // 5. –£–∫–∞–∑—ã–≤–∞–µ–º –∫—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è
  url.searchParams.append("return_to", this.REDIRECT_ORIGIN);

  // 6. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Ç–æ–≤—É—é —Å—Å—ã–ª–∫—É
  return { url: url.href };
}
```

---

## üîê –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å (hash)

### **–ß—Ç–æ —Ç–∞–∫–æ–µ hash:**

**Hash - —ç—Ç–æ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.**

–ê–Ω–∞–ª–æ–≥–∏—è: –ö–∞–∫ –ø–µ—á–∞—Ç—å –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–µ, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —à—Ç–∞–º–ø–∞.

### **–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ (Telegram):**

#### **–®–∞–≥ 1: Telegram —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

```javascript
const userData = {
  id: "123456789",
  first_name: "–†—É—Å–ª–∞–Ω",
  username: "ruslan",
  auth_date: "1708012345",
};
```

#### **–®–∞–≥ 2: –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö**

```javascript
// –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç
const dataString = [
  "auth_date=1708012345",
  "first_name=–†—É—Å–ª–∞–Ω",
  "id=123456789",
  "username=ruslan",
].join("\n");

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// "auth_date=1708012345\nfirst_name=–†—É—Å–ª–∞–Ω\nid=123456789\nusername=ruslan"
```

#### **–®–∞–≥ 3: –°–æ–∑–¥–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ BOT_TOKEN**

```javascript
const secretKey = SHA256(BOT_TOKEN);
// SHA256("123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11")
// ‚Üí "a1b2c3d4e5f6..." (32 –±–∞–π—Ç–∞)
```

#### **–®–∞–≥ 4: –°–æ–∑–¥–∞–µ—Ç HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å**

```javascript
const hash = HMAC_SHA256(secretKey, dataString);
// ‚Üí "f7a8b9c0d1e2..." (64 —Å–∏–º–≤–æ–ª–∞ hex)
```

#### **–®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ + hash**

```javascript
{
  id: "123456789",
  first_name: "–†—É—Å–ª–∞–Ω",
  username: "ruslan",
  auth_date: "1708012345",
  hash: "f7a8b9c0d1e2..."  // ‚Üê –ü–æ–¥–ø–∏—Å—å
}
```

### **–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ (–í–∞—à —Å–µ—Ä–≤–µ—Ä):**

#### **–ü–æ–ª–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```typescript
// TelegramService.checkTelegramAuth()
private checkTelegramAuth(query: Record<string, string>) {
  // 1. –ò–∑–≤–ª–µ–∫–∞–µ–º hash –æ—Ç Telegram
  const hash = query.hash;
  if (!hash) {
    return false;
  }

  // 2. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–æ–º–µ hash)
  const dataCheckArr = Object.keys(query)
    .filter((key) => key !== "hash")  // –ò—Å–∫–ª—é—á–∞–µ–º hash
    .sort()                            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    .map((k) => `${k}=${query[k]}`);  // –§–æ—Ä–º–∞—Ç: key=value

  const dataCheckStr = dataCheckArr.join("\n");
  // –†–µ–∑—É–ª—å—Ç–∞—Ç: "auth_date=1708012345\nfirst_name=–†—É—Å–ª–∞–Ω\n..."

  // 3. –°–æ–∑–¥–∞–µ–º –¢–û–¢ –ñ–ï —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ BOT_TOKEN
  const secretKey = createHash("sha256")
    .update(`${this.BOT_ID}:${this.BOT_TOKEN}`)
    .digest("hex");

  // 4. –°–æ–∑–¥–∞–µ–º –¢–û–¢ –ñ–ï HMAC-SHA256
  const hmac = createHmac("sha256", secretKey)
    .update(dataCheckStr)
    .digest("hex");

  // 5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏
  const isAuthValid = hmac === hash;

  return isAuthValid;  // true = –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ!
}
```

### **–í–∏–∑—É–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```
Telegram —Å–æ–∑–¥–∞–µ—Ç:
  –î–∞–Ω–Ω—ã–µ ‚Üí –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ‚Üí –°—Ç—Ä–æ–∫–∞ ‚Üí HMAC-SHA256(BOT_TOKEN) ‚Üí hash_telegram

–í–∞—à —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç:
  –î–∞–Ω–Ω—ã–µ ‚Üí –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ‚Üí –°—Ç—Ä–æ–∫–∞ ‚Üí HMAC-SHA256(BOT_TOKEN) ‚Üí hash_server

–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:
  hash_telegram === hash_server ?
  ‚úÖ –î–∞ ‚Üí –î–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ
  ‚ùå –ù–µ—Ç ‚Üí –ü–æ–¥–¥–µ–ª–∫–∞!
```

### **–ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:**

#### **1. –ù—É–∂–µ–Ω BOT_TOKEN –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏:**

```
–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–¥–µ–ª–∞—Ç—å:
  –î–∞–Ω–Ω—ã–µ: id=999999, first_name=Hacker
  ‚Üì
  –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É: "first_name=Hacker\nid=999999"
  ‚Üì
  –ù—É–∂–µ–Ω BOT_TOKEN –¥–ª—è HMAC... ‚ùå –ù–ï–¢ –¢–û–ö–ï–ù–ê!
  ‚Üì
  –ù–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π hash
  ‚Üì
  –°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç: hash –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
```

#### **2. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å BOT_TOKEN –∏–∑ hash:**

```
HMAC-SHA256 - –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è:
  BOT_TOKEN + –î–∞–Ω–Ω—ã–µ ‚Üí hash ‚úÖ (–ª–µ–≥–∫–æ)
  hash ‚Üí BOT_TOKEN ‚ùå (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ)
```

#### **3. –ú–∞–ª–µ–π—à–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Üí –¥—Ä—É–≥–æ–π hash:**

```
–î–∞–Ω–Ω—ã–µ: "first_name=–†—É—Å–ª–∞–Ω"
Hash: "f7a8b9c0d1e2..."

–ò–∑–º–µ–Ω–µ–Ω–∏–µ: "first_name=–†—É—Å–ª–∞–Ω " (–¥–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–±–µ–ª)
Hash: "a1b2c3d4e5f6..." (—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –¥—Ä—É–≥–æ–π!)
```

### **–ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:**

‚úÖ **–û—Ç –ø–æ–¥–¥–µ–ª–∫–∏ ID** - –Ω–µ–ª—å–∑—è –≤—ã–¥–∞—Ç—å —Å–µ–±—è –∑–∞ –¥—Ä—É–≥–æ–≥–æ  
‚úÖ **–û—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** - –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è/username  
‚úÖ **–û—Ç replay –∞—Ç–∞–∫** - auth_date –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å  
‚úÖ **–û—Ç MITM** - –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏

### **–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```typescript
// –î–∞–Ω–Ω—ã–µ –æ—Ç Telegram
const telegramData = {
  id: "123456789",
  first_name: "–†—É—Å–ª–∞–Ω",
  username: "ruslan",
  auth_date: "1708012345",
  hash: "f7a8b9c0d1e2...",
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞
const isValid = this.checkTelegramAuth(telegramData);

if (isValid) {
  console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ –æ—Ç Telegram!");
  // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
} else {
  console.log("‚ùå –ü–æ–¥–¥–µ–ª–∫–∞! –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å!");
  throw new Error("Invalid Telegram auth");
}
```

---

## ÔøΩüì± –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ —à–∞–≥–∞–º

### **–®–∞–≥ 1: –í—ã –Ω–∞–∂–∏–º–∞–µ—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–í—ã ‚Üí –°–∞–π—Ç: "–•–æ—á—É –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram!"
–°–∞–π—Ç ‚Üí –°–µ—Ä–≤–µ—Ä: "–î–∞–π –º–Ω–µ —Å—Å—ã–ª–∫—É –¥–ª—è Telegram"
–°–µ—Ä–≤–µ—Ä: "–í–æ—Ç —Å—Å—ã–ª–∫–∞: https://telegram.org/auth?bot_id=123..."
–°–∞–π—Ç ‚Üí –í—ã: "–ü–µ—Ä–µ—Ö–æ–¥–∏ –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ"
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- –í—ã –ø—Ä–æ—Å–∏—Ç–µ —Å–∞–π—Ç –¥–∞—Ç—å –≤–∞–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
- –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É —Å ID –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
- –≠—Ç–∞ —Å—Å—ã–ª–∫–∞ –≤–µ–¥–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Telegram

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–ß—Ç–æ–±—ã Telegram –∑–Ω–∞–ª, –∫–∞–∫–æ–π –±–æ—Ç —Ö–æ—á–µ—Ç –≤–∞—Å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å.

**–ö–æ–¥:**

```typescript
// TelegramService.getAuthUrl()
const url = new URL(`https://oauth.telegram.org/auth`);
url.searchParams.append("bot_id", this.BOT_ID);
url.searchParams.append("origin", this.REDIRECT_ORIGIN);
url.searchParams.append("request_access", "write");
url.searchParams.append("return_to", this.REDIRECT_ORIGIN);
return { url: url.href };
```

---

### **–®–∞–≥ 2: –í—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ø–∞–¥–∞–µ—Ç–µ –Ω–∞ Telegram**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–í—ã –∫–ª–∏–∫–∞–µ—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ
‚Üì
–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Telegram
‚Üì
Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–°–∞–π—Ç '–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä' —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å –∫—Ç–æ –≤—ã. –†–∞–∑—Ä–µ—à–∏—Ç—å?"
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- Telegram —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤–∞—à–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–æ–π —Å–∞–π—Ç —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
- –í—ã –≤–∏–¥–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –∏–ª–∏ "–û—Ç–º–µ–Ω–∏—Ç—å"

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–î–ª—è –≤–∞—à–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –≤—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç–µ –∫—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ.

---

### **–®–∞–≥ 3: –í—ã –Ω–∞–∂–∏–º–∞–µ—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–í—ã: "–†–∞–∑—Ä–µ—à–∞—é!"
‚Üì
Telegram —Å–æ–±–∏—Ä–∞–µ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:
- ID: 123456789
- –ò–º—è: –†—É—Å–ª–∞–Ω
- Username: @ruslan
- –î–∞—Ç–∞: 15.02.2026
‚Üì
Telegram —Å–æ–∑–¥–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å—å (hash):
"–Ø, Telegram, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é —á—Ç–æ —ç—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –†—É—Å–ª–∞–Ω–∞"
‚Üì
Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∞—Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–∞–π—Ç —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- Telegram –±–µ—Ä–µ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
- –î–æ–±–∞–≤–ª—è–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –ø–æ–¥–ø–∏—Å—å (–∫–∞–∫ –ø–µ—á–∞—Ç—å –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–µ)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∞—Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–∞–π—Ç —Å —ç—Ç–∏–º "–¥–æ–∫—É–º–µ–Ω—Ç–æ–º"

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–ü–æ–¥–ø–∏—Å—å –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ –∏ –Ω–µ –ø–æ–¥–¥–µ–ª–∞–Ω—ã.

**–î–∞–Ω–Ω—ã–µ –æ—Ç Telegram:**

```javascript
{
  id: "123456789",
  first_name: "–†—É—Å–ª–∞–Ω",
  username: "ruslan",
  auth_date: "1708012345",
  hash: "a1b2c3d4e5f6..."  // –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å
}
```

---

### **–®–∞–≥ 4: –í—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç —Å –¥–∞–Ω–Ω—ã–º–∏**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
Telegram ‚Üí –°–∞–π—Ç: "–í–æ—Ç –†—É—Å–ª–∞–Ω! –í–æ—Ç –µ–≥–æ –¥–∞–Ω–Ω—ã–µ + –º–æ—è –ø–æ–¥–ø–∏—Å—å"
–°–∞–π—Ç ‚Üí –°–µ—Ä–≤–µ—Ä: "–ü—Ä–æ–≤–µ—Ä—å, —ç—Ç–æ –ø—Ä–∞–≤–¥–∞ Telegram –ø—Ä–∏—Å–ª–∞–ª?"
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- –í—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç
- –°–∞–π—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
- –°–∞–π—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–°–∞–π—Ç –¥–æ–ª–∂–µ–Ω —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ.

**–ö–æ–¥ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ:**

```javascript
// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
const telegramData = getTelegramAuthData();

// –ö–æ–¥–∏—Ä—É–µ–º –≤ base64
const encoded = btoa(JSON.stringify(telegramData));

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
fetch("/auth/telegram/verify", {
  method: "POST",
  body: JSON.stringify({ tgAuthResult: encoded }),
});
```

---

### **–®–∞–≥ 5: –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å Telegram**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–°–µ—Ä–≤–µ—Ä –±–µ—Ä–µ—Ç:
1. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ (ID, –∏–º—è, username)
2. –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä –∏ Telegram –∑–Ω–∞—é—Ç)
3. –°–æ–∑–¥–∞–µ—Ç —Å–≤–æ—é –ø–æ–¥–ø–∏—Å—å –∏–∑ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö
4. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ø–æ–¥–ø–∏—Å—å—é –æ—Ç Telegram

–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç:
‚úÖ "–î–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ!"

–ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç:
‚ùå "–ö—Ç–æ-—Ç–æ –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–º–∞–Ω—É—Ç—å!"
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç "–ø–µ—á–∞—Ç—å" –æ—Ç Telegram
- –ö–∞–∫ –±–∞–Ω–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –Ω–∞ —á–µ–∫–µ
- –ï—Å–ª–∏ –ø–µ—á–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∞—è - –≤—Å–µ –û–ö

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–ó–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–¥–¥–µ–ª–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```typescript
// TelegramService.checkTelegramAuth()
private checkTelegramAuth(query: Record<string, string>) {
  // 1. –ò–∑–≤–ª–µ–∫–∞–µ–º hash –æ—Ç Telegram
  const hash = query.hash;

  // 2. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–æ–º–µ hash)
  const dataCheckArr = Object.keys(query)
    .filter((key) => key !== "hash")
    .sort()
    .map((k) => `${k}=${query[k]}`);
  const dataCheckStr = dataCheckArr.join("\n");

  // 3. –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ bot_token
  const secretKey = createHash("sha256")
    .update(`${this.BOT_ID}:${this.BOT_TOKEN}`)
    .digest("hex");

  // 4. –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –ø–æ–¥–ø–∏—Å—å
  const hmac = createHmac("sha256", secretKey)
    .update(dataCheckStr)
    .digest("hex");

  // 5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏
  return hmac === hash;  // true = –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–µ
}
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è:**

```
–î–∞–Ω–Ω—ã–µ: "id=123456789\nfirst_name=–†—É—Å–ª–∞–Ω\nusername=ruslan"
      ‚Üì
–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á: SHA256(bot_token)
      ‚Üì
HMAC-SHA256(—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á, –¥–∞–Ω–Ω—ã–µ)
      ‚Üì
–ü–æ–¥–ø–∏—Å—å: "a1b2c3d4e5f6..."
      ‚Üì
–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–æ–¥–ø–∏—Å—å—é –æ—Ç Telegram
      ‚Üì
–°–æ–≤–ø–∞–¥–∞–µ—Ç? ‚úÖ –ù–∞—Å—Ç–æ—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ!
```

---

### **–®–∞–≥ 6: –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç - –≤—ã —É–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å?**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–°–µ—Ä–≤–µ—Ä —Å–º–æ—Ç—Ä–∏—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:
"–ï—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID = 123456789?"

–í–∞—Ä–∏–∞–Ω—Ç –ê: –î–∞, –µ—Å—Ç—å!
‚Üí "–û—Ç–ª–∏—á–Ω–æ! –í—ã–¥–∞—é —Ç–æ–∫–µ–Ω—ã –¥–ª—è –≤—Ö–æ–¥–∞"
‚Üí –í—ã –≤–æ—à–ª–∏! ‚úÖ

–í–∞—Ä–∏–∞–Ω—Ç –ë: –ù–µ—Ç, –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
‚Üí "–°–æ–∑–¥–∞—é –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –≤ Redis"
‚Üí "–û—Ç–ø—Ä–∞–≤–ª—è—é —Å—Å—ã–ª–∫—É –Ω–∞ –±–æ—Ç–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
‚Üí –ù—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- –°–µ—Ä–≤–µ—Ä –∏—â–µ—Ç –≤–∞—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ Telegram ID
- –ï—Å–ª–∏ –Ω–∞—à–µ–ª - —Å—Ä–∞–∑—É –ø—É—Å–∫–∞–µ—Ç
- –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–µ–ª - –ø—Ä–æ—Å–∏—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–†–∞–∑–¥–µ–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ö–æ–¥:**

```typescript
// TelegramService.verify()
const telegramId = data.query.id;
const existingUser =
  await this.telegramRepository.findUserByTelegramId(telegramId);

if (existingUser && existingUser.phone) {
  // –í–∞—Ä–∏–∞–Ω—Ç –ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  return this.tokenService.generateTokens(existingUser.id);
} else {
  // –í–∞—Ä–∏–∞–Ω—Ç –ë: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const sessionId = randomBytes(16).toString("hex");
  await this.redisService.set(
    `telegram_session:${sessionId}`,
    JSON.stringify({ telegramId, username: data.query.username }),
    "EX",
    300, // 5 –º–∏–Ω—É—Ç
  );
  return { url: `http://t.me/${this.BOT_USERNAME}?start=${sessionId}` };
}
```

---

### **–®–∞–≥ 7–ê: –ï—Å–ª–∏ –≤—ã —É–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å - –ø–æ–ª—É—á–∞–µ—Ç–µ —Ç–æ–∫–µ–Ω—ã**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç 2 –∫–ª—é—á–∞:
1. Access Token (–∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª—é—á –Ω–∞ 15 –º–∏–Ω—É—Ç)
   - –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∞–π—Ç—É

2. Refresh Token (–¥–ª–∏–Ω–Ω—ã–π –∫–ª—é—á –Ω–∞ 7 –¥–Ω–µ–π)
   - –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∫–ª—é—á–∞

–°–µ—Ä–≤–µ—Ä ‚Üí –°–∞–π—Ç: "–í–æ—Ç —Ç–æ–∫–µ–Ω—ã!"
–°–∞–π—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:
- Access Token –≤ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- Refresh Token –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –∫—É–∫–µ

–í—ã –≤–æ—à–ª–∏! üéâ
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- –°–µ—Ä–≤–µ—Ä –¥–∞–µ—Ç –≤–∞–º 2 –ø—Ä–æ–ø—É—Å–∫–∞
- –ö–æ—Ä–æ—Ç–∫–∏–π - –¥–ª—è –≤—Ö–æ–¥–∞ —Å–µ–π—á–∞—Å
- –î–ª–∏–Ω–Ω—ã–π - —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–≥–¥–∞ –∏—Å—Ç–µ—á–µ—Ç
- –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–∞–π—Ç–æ–º

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É.

**–ö–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:**

```typescript
// TokenService.generateTokens()
public generateTokens(userId: string) {
  const accessToken = this.passportService.generateToken(
    userId,
    this.ACCESS_TOKEN_TTL  // 15 –º–∏–Ω—É—Ç
  );
  const refreshToken = this.passportService.generateToken(
    userId,
    this.REFRESH_TOKEN_TTL  // 7 –¥–Ω–µ–π
  );
  return { accessToken, refreshToken };
}
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã:**

```javascript
// –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
localStorage.setItem("accessToken", accessToken);
// Refresh token –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ httpOnly –∫—É–∫–µ

// –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ API
fetch("/api/movies", {
  headers: {
    Authorization: `Bearer ${accessToken}`,
  },
});

// –ö–æ–≥–¥–∞ access token –∏—Å—Ç–µ–∫–∞–µ—Ç
fetch("/auth/refresh", {
  method: "POST",
  credentials: "include", // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç refresh token –∏–∑ –∫—É–∫–∏
});
```

---

### **–®–∞–≥ 7–ë: –ï—Å–ª–∏ –≤—ã –Ω–æ–≤—ã–π - –Ω—É–∂–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –≤ Redis:
{
  telegram_id: 123456789,
  username: "ruslan",
  expires: —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
}

–°–µ—Ä–≤–µ—Ä ‚Üí –°–∞–π—Ç: "–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞: t.me/bot?start=abc123"
–°–∞–π—Ç ‚Üí –í—ã: "–ü–µ—Ä–µ–π–¥–∏ –≤ –±–æ—Ç–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"

–í—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ –±–æ—Ç–∞
‚Üì
–ë–æ—Ç –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email
‚Üì
–í—ã –≤–≤–æ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ
‚Üì
–ë–æ—Ç —Å–≤—è–∑—ã–≤–∞–µ—Ç Telegram ID —Å –≤–∞—à–∏–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
‚Üì
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! ‚úÖ
```

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**

- –°–µ—Ä–≤–µ—Ä –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –≤–∞—Å –Ω–∞ 5 –º–∏–Ω—É—Ç
- –î–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –±–æ—Ç–∞
- –í –±–æ—Ç–µ –≤—ã –¥–æ–ø–æ–ª–Ω—è–µ—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å (—Ç–µ–ª–µ—Ñ–æ–Ω/email)
- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–µ—Ç–µ –≤—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Telegram

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
–ß—Ç–æ–±—ã —É –≤–∞—Å –±—ã–ª –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏.

**–î–∞–Ω–Ω—ã–µ –≤ Redis:**

```
–ö–ª—é—á: telegram_session:abc123def456
–ó–Ω–∞—á–µ–Ω–∏–µ: {
  "telegramId": "123456789",
  "username": "ruslan"
}
TTL: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)
```

**–ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è 5 –º–∏–Ω—É—Ç:**

- –°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ Redis
- –ù—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–Ω–æ–≤–æ

---

## üéØ –í—Å—è —Å—Ö–µ–º–∞ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π

```
1. –í—ã ‚Üí –°–∞–π—Ç: "–•–æ—á—É —á–µ—Ä–µ–∑ Telegram!"
2. –°–∞–π—Ç ‚Üí –í—ã: "–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ Telegram"
3. –í—ã ‚Üí Telegram: "–†–∞–∑—Ä–µ—à–∞—é!"
4. Telegram ‚Üí –°–∞–π—Ç: "–í–æ—Ç –¥–∞–Ω–Ω—ã–µ + –ø–æ–¥–ø–∏—Å—å"
5. –°–∞–π—Ç ‚Üí –°–µ—Ä–≤–µ—Ä: "–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–ø–∏—Å—å"
6. –°–µ—Ä–≤–µ—Ä: "–ü–æ–¥–ø–∏—Å—å –û–ö! –ò—â—É –≤ –±–∞–∑–µ..."

   –ï—Å–ª–∏ –Ω–∞—à–µ–ª:
   7–ê. –°–µ—Ä–≤–µ—Ä ‚Üí –í—ã: "–í–æ—Ç —Ç–æ–∫–µ–Ω—ã, –∑–∞—Ö–æ–¥–∏!"

   –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–µ–ª:
   7–ë. –°–µ—Ä–≤–µ—Ä ‚Üí –í—ã: "–ò–¥–∏ –≤ –±–æ—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è"
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### **–ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø–æ–¥–¥–µ–ª–∞—Ç—å –¥–∞–Ω–Ω—ã–µ:**

1. **–ù—É–∂–µ–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á**
   - –¢–æ–ª—å–∫–æ Telegram –∏ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –∑–Ω–∞—é—Ç bot_token
   - –ë–µ–∑ –Ω–µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å—å

2. **HMAC-SHA256**
   - –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º
   - –î–∞–∂–µ –º–∞–ª–µ–π—à–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Üí –¥—Ä—É–≥–∞—è –ø–æ–¥–ø–∏—Å—å

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É
   - –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ

### **–ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:**

‚úÖ **–û—Ç –ø–æ–¥–¥–µ–ª–∫–∏ ID** - –Ω–µ–ª—å–∑—è –≤—ã–¥–∞—Ç—å —Å–µ–±—è –∑–∞ –¥—Ä—É–≥–æ–≥–æ  
‚úÖ **–û—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** - –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è/username  
‚úÖ **–û—Ç replay –∞—Ç–∞–∫** - auth_date –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å  
‚úÖ **–û—Ç MITM** - –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏

---

## üí° –ì–ª–∞–≤–Ω–æ–µ

**Telegram OAuth - —ç—Ç–æ –∫–∞–∫ –ø—Ä–æ–ø—É—Å–∫ –≤ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä:**

1. **–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç–µ –ø—Ä–æ–ø—É—Å–∫** (–ø–æ–ª—É—á–∞–µ—Ç–µ —Å—Å—ã–ª–∫—É)
2. **Telegram –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—Å** (–≤—ã —Ä–∞–∑—Ä–µ—à–∞–µ—Ç–µ)
3. **Telegram –¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç** (–¥–∞–Ω–Ω—ã–µ + hash)
4. **–û—Ö—Ä–∞–Ω–Ω–∏–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç** (—Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç hash)
5. **–ü—É—Å–∫–∞—é—Ç –≤–Ω—É—Ç—Ä—å** (–≤—ã–¥–∞—é—Ç —Ç–æ–∫–µ–Ω—ã) –∏–ª–∏ **–ø—Ä–æ—Å—è—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è** (–µ—Å–ª–∏ –Ω–æ–≤—ã–π)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ–ª–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ–ª—å–∫–æ Telegram –∏ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –∑–Ω–∞—é—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏! üîê

---

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram:**

```typescript
interface TelegramAuthData {
  id: string; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
  first_name: string; // –ò–º—è
  last_name?: string; // –§–∞–º–∏–ª–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  username?: string; // @username (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  photo_url?: string; // URL –∞–≤–∞—Ç–∞—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  auth_date: string; // Timestamp –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  hash: string; // HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
}
```

### **–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ hash:**

```
1. –ò–∑–≤–ª–µ—á—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—Ä–æ–º–µ hash
2. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
3. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–æ–∫—É: "key1=value1\nkey2=value2\n..."
4. –°–æ–∑–¥–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á: SHA256(bot_token)
5. –°–æ–∑–¥–∞—Ç—å HMAC: HMAC-SHA256(—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á, —Å—Ç—Ä–æ–∫–∞_–¥–∞–Ω–Ω—ã—Ö)
6. –°—Ä–∞–≤–Ω–∏—Ç—å —Å hash –æ—Ç Telegram
```

### **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**

- **OAuth URL** - –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ)
- **Telegram session** - 24 —á–∞—Å–∞ (Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
- **Redis session** - 5 –º–∏–Ω—É—Ç (–¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- **Access token** - 15 –º–∏–Ω—É—Ç
- **Refresh token** - 7 –¥–Ω–µ–π

### **Endpoints:**

```
GET  /auth/telegram          - –ü–æ–ª—É—á–∏—Ç—å OAuth URL
POST /auth/telegram/verify   - –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
POST /auth/refresh           - –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
POST /auth/logout            - –í—ã–π—Ç–∏ (–æ—á–∏—Å—Ç–∏—Ç—å –∫—É–∫–∏)
```

---

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Telegram OAuth

### **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

- ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤—Ö–æ–¥ (1 –∫–ª–∏–∫)
- üîê –ù–µ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å –ø–∞—Ä–æ–ª—å
- üì± –£–¥–æ–±–Ω–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- ‚úÖ Telegram –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–∞—à—É –ª–∏—á–Ω–æ—Å—Ç—å

### **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**

- üõ°Ô∏è –í—ã—Å–æ–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- üîÑ –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- üìä –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üö´ –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏

### **–î–ª—è –ø—Ä–æ–µ–∫—Ç–∞:**

- üìà –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
- üîÑ –°–Ω–∏–∂–µ–Ω–∏–µ –æ—Ç—Ç–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üí∞ –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ SMS/Email —Å–µ—Ä–≤–∏—Å–∞—Ö
- üåç –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (Telegram –ø–æ–ø—É–ª—è—Ä–µ–Ω –≤–µ–∑–¥–µ)
